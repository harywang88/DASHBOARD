<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HarywangPDF</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f172a;--bg2:#1e293b;--bg3:#334155;--border:#475569;--text:#f1f5f9;--text2:#94a3b8;--accent:#ec4899;--accent2:#be185d}
html,body{height:100%;overflow:hidden}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}

/* HOME */
#homeView{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px}
.home-title{font-size:36px;font-weight:700;margin-bottom:8px}
.home-title span{color:var(--accent)}
.home-sub{color:var(--text2);margin-bottom:40px;font-size:15px}
.home-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;max-width:900px;width:100%}
.home-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px 20px;cursor:pointer;text-align:center;transition:all .3s}
.home-card:hover{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 8px 30px rgba(236,72,153,.15)}
.home-card-icon{font-size:32px;margin-bottom:10px;line-height:1}
.home-card h3{font-size:16px;margin-bottom:4px}
.home-card p{font-size:12px;color:var(--text2)}

/* EDITOR */
#editorView{height:100%;display:none;flex-direction:column}
#toolbar{background:var(--bg2);border-bottom:1px solid var(--border);padding:5px 10px;display:flex;align-items:center;gap:3px;flex-shrink:0;overflow-x:auto}
.tb{width:34px;height:34px;border:none;background:transparent;color:var(--text2);border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;flex-shrink:0}
.tb:hover{background:var(--bg3);color:var(--text)}
.tb.active{background:var(--accent);color:#fff}
.tb:disabled{opacity:.3;cursor:default}
.tb:disabled:hover{background:transparent;color:var(--text2)}
.tb svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.tb-save{background:var(--accent)!important;color:#fff!important;width:auto;padding:0 12px;gap:5px;font-weight:600;font-size:12px;white-space:nowrap}
.tb-save:hover{background:var(--accent2)!important}
.tsep{width:1px;height:22px;background:var(--border);margin:0 3px;flex-shrink:0}
.tsp{flex:1;min-width:8px}
#toolOpts{display:flex;align-items:center;gap:4px}
#toolOpts input[type="color"]{width:26px;height:26px;border:none;border-radius:5px;cursor:pointer;background:none;padding:0}
#toolOpts select{padding:3px 6px;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:5px;font-size:11px}

/* Main */
#mainArea{flex:1;display:flex;overflow:hidden}
#sidebar{width:140px;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;padding:6px;flex-shrink:0}
.thumb{background:var(--bg3);border:2px solid transparent;border-radius:5px;margin-bottom:6px;cursor:pointer;overflow:hidden;position:relative}
.thumb.active{border-color:var(--accent)}
.thumb canvas{width:100%;display:block}
.thumb-num{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.6);color:#fff;font-size:10px;text-align:center;padding:1px}

#viewerWrap{flex:1;overflow:auto;background:#525659;display:flex;justify-content:center;align-items:flex-start;padding:16px}
#viewer{position:relative;line-height:0}
#pdfCanvas{display:block}
#overlayCanvas{position:absolute;top:0;left:0;cursor:crosshair}

/* Text input */
.tinput{position:absolute;z-index:10}
.tinput textarea{border:2px dashed var(--accent);background:rgba(255,255,255,.92);color:#000;padding:3px;font-family:Arial,sans-serif;resize:both;outline:none;min-width:50px;min-height:24px}

/* Status */
#statusBar{background:var(--bg2);border-top:1px solid var(--border);padding:5px 14px;display:flex;align-items:center;gap:6px;font-size:12px;flex-shrink:0}
#statusBar button{width:26px;height:26px;border:none;background:var(--bg3);color:var(--text);border-radius:5px;cursor:pointer;font-size:13px}
#statusBar button:hover{background:var(--accent)}
.ssp{flex:1}
#pageInfo,#zoomInfo{color:var(--text2);min-width:50px;text-align:center}

/* Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
.mo.show{display:flex}
.mc{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:28px;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;margin:16px}
.mc h3{font-size:18px;margin-bottom:6px}
.mc p{color:var(--text2);font-size:13px;margin-bottom:14px}
.mc input[type="file"]{width:100%;padding:10px;background:var(--bg);border:2px dashed var(--border);border-radius:8px;color:var(--text);margin-bottom:10px;font-size:13px}
.mc input[type="text"],.mc select{width:100%;padding:9px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;margin-bottom:10px}
.mc label{display:block;font-size:12px;color:var(--text2);margin-bottom:4px}
.mact{display:flex;gap:6px;justify-content:flex-end;margin-top:14px}
.mact button{padding:9px 18px;border:none;border-radius:7px;cursor:pointer;font-weight:600;font-size:13px}
.mact .mbtn{background:var(--bg3);color:var(--text)}
.mact .mpri{background:var(--accent);color:#fff}
.mact button:hover{opacity:.85}
.mst{margin-top:10px;padding:8px;border-radius:7px;font-size:12px;display:none}
.mst.show{display:block}
.mst.err{background:rgba(239,68,68,.1);color:#fca5a5}
.mst.ok{background:rgba(16,185,129,.1);color:#6ee7b7}
.mst.ld{background:rgba(99,102,241,.1);color:#a5b4fc}

#signCanvas{width:100%;height:180px;background:#fff;border-radius:7px;cursor:crosshair;display:block;touch-action:none}

/* Note tooltip */
.ntip{position:absolute;background:#fef3c7;color:#78350f;padding:6px 10px;border-radius:5px;font-size:11px;max-width:180px;pointer-events:none;z-index:20;box-shadow:0 2px 8px rgba(0,0,0,.2);white-space:pre-wrap}

/* File list */
.flist{max-height:120px;overflow-y:auto;margin-bottom:8px}
.flist-item{padding:4px 8px;background:var(--bg);border-radius:4px;margin-bottom:3px;font-size:12px;color:var(--text2)}

@media(max-width:768px){
    #sidebar{width:90px}
    .home-grid{grid-template-columns:1fr 1fr}
}
@media(max-width:480px){
    #sidebar{display:none}
    .home-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- HOME VIEW -->
<div id="homeView">
    <h1 class="home-title">Harywang<span>PDF</span></h1>
    <p class="home-sub">Edit, merge, split, compress & convert PDF</p>
    <div class="home-grid">
        <div class="home-card" onclick="triggerUpload()">
            <div class="home-card-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>
            <h3>Edit PDF</h3>
            <p>Text, draw, sign, highlight</p>
        </div>
        <div class="home-card" onclick="openModal('merge')">
            <div class="home-card-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2" stroke-linecap="round"><rect x="2" y="3" width="8" height="8" rx="1"/><rect x="14" y="3" width="8" height="8" rx="1"/><rect x="8" y="13" width="8" height="8" rx="1"/><path d="M6 11v2M18 11v2M12 11v2"/></svg></div>
            <h3>Merge</h3>
            <p>Gabung beberapa PDF</p>
        </div>
        <div class="home-card" onclick="openModal('split')">
            <div class="home-card-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2" stroke-linecap="round"><path d="M16 3h5v5M8 3H3v5M12 22V8M12 8l4-5M12 8L8 3"/></svg></div>
            <h3>Split</h3>
            <p>Pisah halaman PDF</p>
        </div>
        <div class="home-card" onclick="openModal('compress')">
            <div class="home-card-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></div>
            <h3>Compress</h3>
            <p>Kompres ukuran PDF</p>
        </div>
        <div class="home-card" onclick="openModal('convert')">
            <div class="home-card-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2" stroke-linecap="round"><path d="M21 3H3v18h18V3z"/><path d="M9 9h6v6H9z"/></svg></div>
            <h3>Convert</h3>
            <p>PDF ke gambar / text</p>
        </div>
    </div>
    <input type="file" id="fileInput" accept=".pdf" style="display:none" onchange="handleFile(this)">
</div>

<!-- EDITOR VIEW -->
<div id="editorView">
    <div id="toolbar">
        <button class="tb" onclick="closeEditor()" title="Kembali"><svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
        <div class="tsep"></div>
        <button class="tb" id="undoBtn" onclick="doUndo()" title="Undo" disabled><svg viewBox="0 0 24 24"><path d="M3 10h10a5 5 0 015 5v0a5 5 0 01-5 5H9"/><path d="M3 10l4-4M3 10l4 4"/></svg></button>
        <button class="tb" id="redoBtn" onclick="doRedo()" title="Redo" disabled><svg viewBox="0 0 24 24"><path d="M21 10H11a5 5 0 00-5 5v0a5 5 0 005 5h4"/><path d="M21 10l-4-4M21 10l-4 4"/></svg></button>
        <div class="tsep"></div>
        <button class="tb" data-tool="text" onclick="selectTool('text')" title="Text"><b>T</b></button>
        <button class="tb" data-tool="sign" onclick="selectTool('sign')" title="Tanda Tangan"><svg viewBox="0 0 24 24"><path d="M17.5 2.5l4 4L7 21H3v-4L17.5 2.5z"/></svg></button>
        <button class="tb" data-tool="line" onclick="selectTool('line')" title="Garis"><svg viewBox="0 0 24 24"><line x1="5" y1="19" x2="19" y2="5"/></svg></button>
        <button class="tb" data-tool="draw" onclick="selectTool('draw')" title="Gambar Bebas"><svg viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>
        <button class="tb" data-tool="eraser" onclick="selectTool('eraser')" title="Hapus"><svg viewBox="0 0 24 24"><path d="M20 20H7L3 16l8-8 9 9-4 3z"/><path d="M6 11l8-8"/></svg></button>
        <button class="tb" data-tool="highlight" onclick="selectTool('highlight')" title="Highlight"><svg viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="8" rx="1" fill="rgba(236,72,153,.3)"/></svg></button>
        <button class="tb" data-tool="image" onclick="selectTool('image')" title="Sisipkan Gambar"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></button>
        <button class="tb" data-tool="note" onclick="selectTool('note')" title="Catatan"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg></button>
        <div class="tsep"></div>
        <div id="toolOpts">
            <input type="color" id="toolColor" value="#000000" title="Warna">
            <select id="toolSize" title="Ketebalan">
                <option value="1">1px</option>
                <option value="2" selected>2px</option>
                <option value="4">4px</option>
                <option value="6">6px</option>
            </select>
            <select id="toolFontSize" title="Ukuran Font">
                <option value="12">12</option>
                <option value="16" selected>16</option>
                <option value="20">20</option>
                <option value="24">24</option>
                <option value="32">32</option>
                <option value="48">48</option>
            </select>
        </div>
        <div class="tsp"></div>
        <button class="tb" onclick="printDoc()" title="Print"><svg viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg></button>
        <button class="tb tb-save" onclick="saveAndDownload()"><svg viewBox="0 0 24 24" style="width:14px;height:14px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg> Save</button>
    </div>
    <div id="mainArea">
        <div id="sidebar"><div id="thumbs"></div></div>
        <div id="viewerWrap">
            <div id="viewer">
                <canvas id="pdfCanvas"></canvas>
                <canvas id="overlayCanvas"></canvas>
            </div>
        </div>
    </div>
    <div id="statusBar">
        <button onclick="goPage(-1)" title="Halaman sebelumnya">&lsaquo;</button>
        <span id="pageInfo">1 / 1</span>
        <button onclick="goPage(1)" title="Halaman berikutnya">&rsaquo;</button>
        <div class="ssp"></div>
        <button onclick="changeZoom(-1)">-</button>
        <span id="zoomInfo">100%</span>
        <button onclick="changeZoom(1)">+</button>
    </div>
</div>

<!-- MODALS -->
<!-- Merge -->
<div class="mo" id="mergeModal"><div class="mc">
    <h3>Merge PDF</h3><p>Pilih beberapa file PDF untuk digabung menjadi satu</p>
    <input type="file" id="mergeFiles" accept=".pdf" multiple>
    <div class="flist" id="mergeList"></div>
    <div class="mact"><button class="mbtn" onclick="closeModal('merge')">Batal</button><button class="mpri" onclick="doMerge()">Merge</button></div>
    <div class="mst" id="mergeSt"></div>
</div></div>

<!-- Split -->
<div class="mo" id="splitModal"><div class="mc">
    <h3>Split PDF</h3><p>Pisahkan halaman tertentu dari PDF</p>
    <input type="file" id="splitFile" accept=".pdf">
    <label>Halaman (contoh: 1-3, 5, 7-10)</label>
    <input type="text" id="splitPages" placeholder="1-3, 5, 7-10">
    <div class="mact"><button class="mbtn" onclick="closeModal('split')">Batal</button><button class="mpri" onclick="doSplit()">Split</button></div>
    <div class="mst" id="splitSt"></div>
</div></div>

<!-- Compress -->
<div class="mo" id="compressModal"><div class="mc">
    <h3>Compress PDF</h3><p>Kompres ukuran file PDF</p>
    <input type="file" id="compressFile" accept=".pdf">
    <label>Level kompresi</label>
    <select id="compressLevel">
        <option value="low">Low (kualitas tinggi)</option>
        <option value="medium" selected>Medium</option>
        <option value="high">High (ukuran kecil)</option>
    </select>
    <div class="mact"><button class="mbtn" onclick="closeModal('compress')">Batal</button><button class="mpri" onclick="doCompress()">Compress</button></div>
    <div class="mst" id="compressSt"></div>
</div></div>

<!-- Convert -->
<div class="mo" id="convertModal"><div class="mc">
    <h3>Convert PDF</h3><p>Konversi PDF ke format lain</p>
    <input type="file" id="convertFile" accept=".pdf">
    <label>Format</label>
    <select id="convertFormat">
        <option value="image">Gambar (PNG)</option>
        <option value="text">Text</option>
    </select>
    <div class="mact"><button class="mbtn" onclick="closeModal('convert')">Batal</button><button class="mpri" onclick="doConvert()">Convert</button></div>
    <div class="mst" id="convertSt"></div>
</div></div>

<!-- Signature Pad -->
<div class="mo" id="signModal"><div class="mc">
    <h3>Tanda Tangan</h3><p>Gambar tanda tangan di bawah</p>
    <canvas id="signCanvas"></canvas>
    <div class="mact"><button class="mbtn" onclick="clearSign()">Hapus</button><button class="mbtn" onclick="closeModal('sign')">Batal</button><button class="mpri" onclick="useSign()">Gunakan</button></div>
</div></div>

<!-- Note Input -->
<div class="mo" id="noteModal"><div class="mc">
    <h3>Tambah Catatan</h3>
    <label>Isi catatan</label>
    <input type="text" id="noteText" placeholder="Tulis catatan...">
    <div class="mact"><button class="mbtn" onclick="closeModal('note')">Batal</button><button class="mpri" onclick="confirmNote()">Tambah</button></div>
</div></div>

<!-- Image input hidden -->
<input type="file" id="imgInput" accept="image/*" style="display:none" onchange="handleImgFile(this)">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// ========== CONFIG ==========
var basePath = (function(){
    var p = window.location.pathname.replace(/\/index\.html$/i,'').replace(/\/+$/,'');
    return p || '';
})();
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ========== STATE ==========
var pdfDoc = null;
var currentPage = 1;
var totalPages = 0;
var baseScale = 1.5;
var zoomLevel = 1.0;
var currentTool = 'none';
var originalFile = null;
var edits = {};        // pageNum -> [annotation...]
var undoStack = [];
var redoStack = [];
var pageViewports = {};
var isDrawing = false;
var drawPoints = [];
var lineStart = null;
var hlStart = null;
var pendingSign = null; // data URL of signature waiting to be placed
var pendingImg = null;  // data URL of image waiting to be placed
var noteClickPos = null;
var signDrawing = false;
var signPoints = [];
var activeTextInput = null;
var noteTooltipEl = null;

// DOM refs
var pdfCanvas, pdfCtx, overlayCanvas, overlayCtx;

// ========== INIT ==========
window.addEventListener('DOMContentLoaded', function(){
    pdfCanvas = document.getElementById('pdfCanvas');
    pdfCtx = pdfCanvas.getContext('2d');
    overlayCanvas = document.getElementById('overlayCanvas');
    overlayCtx = overlayCanvas.getContext('2d');

    overlayCanvas.addEventListener('mousedown', onMouseDown);
    overlayCanvas.addEventListener('mousemove', onMouseMove);
    overlayCanvas.addEventListener('mouseup', onMouseUp);
    overlayCanvas.addEventListener('mouseleave', onMouseUp);

    // Touch support
    overlayCanvas.addEventListener('touchstart', function(e){ e.preventDefault(); onMouseDown(touchToMouse(e)); }, {passive:false});
    overlayCanvas.addEventListener('touchmove', function(e){ e.preventDefault(); onMouseMove(touchToMouse(e)); }, {passive:false});
    overlayCanvas.addEventListener('touchend', function(e){ e.preventDefault(); onMouseUp(touchToMouse(e)); }, {passive:false});

    // Signature canvas
    var sc = document.getElementById('signCanvas');
    sc.addEventListener('mousedown', signStart);
    sc.addEventListener('mousemove', signMove);
    sc.addEventListener('mouseup', signEnd);
    sc.addEventListener('mouseleave', signEnd);
    sc.addEventListener('touchstart', function(e){e.preventDefault();signStart(touchToMouse(e,sc));},{passive:false});
    sc.addEventListener('touchmove', function(e){e.preventDefault();signMove(touchToMouse(e,sc));},{passive:false});
    sc.addEventListener('touchend', function(e){e.preventDefault();signEnd(touchToMouse(e,sc));},{passive:false});

    // Merge file list
    document.getElementById('mergeFiles').addEventListener('change', function(){
        var list = document.getElementById('mergeList');
        list.innerHTML = '';
        for(var i=0;i<this.files.length;i++){
            var d = document.createElement('div');
            d.className='flist-item';
            d.textContent = this.files[i].name;
            list.appendChild(d);
        }
    });

    // Note tooltip
    noteTooltipEl = document.createElement('div');
    noteTooltipEl.className = 'ntip';
    noteTooltipEl.style.display = 'none';
    document.getElementById('viewer').appendChild(noteTooltipEl);
});

function touchToMouse(e, el){
    var t = e.touches[0] || e.changedTouches[0];
    return {clientX:t.clientX, clientY:t.clientY, target: el||e.target, preventDefault:function(){}};
}

// ========== FILE HANDLING ==========
function triggerUpload(){ document.getElementById('fileInput').click(); }

function handleFile(input){
    var file = input.files[0];
    if(!file) return;
    originalFile = file;
    var reader = new FileReader();
    reader.onload = function(e){ loadPDF(new Uint8Array(e.target.result)); };
    reader.readAsArrayBuffer(file);
}

function loadPDF(data){
    pdfjsLib.getDocument({data:data}).promise.then(function(pdf){
        pdfDoc = pdf;
        totalPages = pdf.numPages;
        currentPage = 1;
        edits = {};
        undoStack = [];
        redoStack = [];
        updateUndoRedoBtns();
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('editorView').style.display = 'flex';
        renderPage(currentPage);
        renderThumbs();
    }).catch(function(err){
        alert('Gagal membuka PDF: ' + err.message);
    });
}

// ========== PDF RENDERING ==========
function renderPage(num){
    pdfDoc.getPage(num).then(function(page){
        var vp = page.getViewport({scale: baseScale * zoomLevel});
        pdfCanvas.width = vp.width;
        pdfCanvas.height = vp.height;
        overlayCanvas.width = vp.width;
        overlayCanvas.height = vp.height;
        pageViewports[num] = {width:vp.width, height:vp.height};

        page.render({canvasContext:pdfCtx, viewport:vp}).promise.then(function(){
            renderOverlay();
        });

        document.getElementById('pageInfo').textContent = num + ' / ' + totalPages;
        document.getElementById('zoomInfo').textContent = Math.round(zoomLevel*100)+'%';

        // Update thumbnail active state
        var thumbs = document.querySelectorAll('.thumb');
        thumbs.forEach(function(t){ t.classList.toggle('active', parseInt(t.dataset.page)===num); });
    });
}

function renderThumbs(){
    var container = document.getElementById('thumbs');
    container.innerHTML = '';
    for(var i=1;i<=totalPages;i++){
        (function(pg){
            pdfDoc.getPage(pg).then(function(page){
                var tvp = page.getViewport({scale:0.3});
                var div = document.createElement('div');
                div.className = 'thumb' + (pg===currentPage?' active':'');
                div.dataset.page = pg;
                div.onclick = function(){ currentPage=pg; renderPage(pg); };
                var c = document.createElement('canvas');
                c.width = tvp.width;
                c.height = tvp.height;
                page.render({canvasContext:c.getContext('2d'),viewport:tvp});
                div.appendChild(c);
                var lbl = document.createElement('div');
                lbl.className='thumb-num';
                lbl.textContent = pg;
                div.appendChild(lbl);
                container.appendChild(div);
            });
        })(i);
    }
}

// ========== OVERLAY RENDERING ==========
function renderOverlay(){
    overlayCtx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);
    var anns = edits[currentPage] || [];
    for(var i=0;i<anns.length;i++){
        drawAnnotation(overlayCtx, anns[i]);
    }
}

function drawAnnotation(ctx, a){
    ctx.save();
    switch(a.type){
        case 'text':
            ctx.font = a.fontSize+'px Arial';
            ctx.fillStyle = a.color||'#000';
            ctx.textBaseline = 'top';
            var lines = (a.text||'').split('\n');
            for(var i=0;i<lines.length;i++){
                ctx.fillText(lines[i], a.x, a.y + i*(a.fontSize+2));
            }
            break;
        case 'draw':
            if(!a.points||a.points.length<2) break;
            ctx.strokeStyle = a.color||'#000';
            ctx.lineWidth = a.lineWidth||2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            ctx.moveTo(a.points[0].x, a.points[0].y);
            for(var i=1;i<a.points.length;i++) ctx.lineTo(a.points[i].x, a.points[i].y);
            ctx.stroke();
            break;
        case 'line':
            ctx.strokeStyle = a.color||'#000';
            ctx.lineWidth = a.lineWidth||2;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(a.x1,a.y1);
            ctx.lineTo(a.x2,a.y2);
            ctx.stroke();
            break;
        case 'highlight':
            ctx.fillStyle = a.color||'rgba(255,255,0,0.35)';
            ctx.fillRect(a.x,a.y,a.w,a.h);
            break;
        case 'image':
        case 'sign':
            if(a.img) ctx.drawImage(a.img, a.x, a.y, a.w, a.h);
            break;
        case 'note':
            ctx.fillStyle = a.color||'#fbbf24';
            ctx.fillRect(a.x-10,a.y-10,20,20);
            ctx.strokeStyle = '#78350f';
            ctx.lineWidth = 1;
            ctx.strokeRect(a.x-10,a.y-10,20,20);
            ctx.fillStyle = '#78350f';
            ctx.font = 'bold 13px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('N',a.x,a.y);
            break;
    }
    ctx.restore();
}

function renderAnnsToCtx(ctx, pageNum){
    var anns = edits[pageNum]||[];
    for(var i=0;i<anns.length;i++) drawAnnotation(ctx, anns[i]);
}

// ========== TOOL SELECTION ==========
function selectTool(tool){
    // If same tool, deselect
    if(currentTool === tool){ currentTool='none'; }
    else{ currentTool = tool; }

    // Update button states
    document.querySelectorAll('.tb[data-tool]').forEach(function(b){
        b.classList.toggle('active', b.dataset.tool===currentTool);
    });

    // Close any active text input
    closeTextInput();

    // Special tool init
    if(currentTool==='sign'){
        pendingSign = null;
        openModal('sign');
        initSignCanvas();
    }
    if(currentTool==='image'){
        pendingImg = null;
        document.getElementById('imgInput').click();
    }

    // Set cursor
    if(currentTool==='eraser') overlayCanvas.style.cursor='pointer';
    else if(currentTool==='text') overlayCanvas.style.cursor='text';
    else if(currentTool==='none') overlayCanvas.style.cursor='default';
    else overlayCanvas.style.cursor='crosshair';
}

// ========== MOUSE EVENTS ==========
function getCoords(e){
    var rect = overlayCanvas.getBoundingClientRect();
    return {
        x: (e.clientX - rect.left) * (overlayCanvas.width / rect.width),
        y: (e.clientY - rect.top) * (overlayCanvas.height / rect.height)
    };
}

function onMouseDown(e){
    var c = getCoords(e);
    switch(currentTool){
        case 'text': handleTextClick(c); break;
        case 'draw': startDraw(c); break;
        case 'line': lineStart = c; break;
        case 'highlight': hlStart = c; break;
        case 'sign': placeSign(c); break;
        case 'image': placeImg(c); break;
        case 'note': handleNoteClick(c); break;
        case 'eraser': handleErase(c); break;
    }
}

function onMouseMove(e){
    var c = getCoords(e);
    switch(currentTool){
        case 'draw': if(isDrawing) continueDraw(c); break;
        case 'line': if(lineStart) previewLine(c); break;
        case 'highlight': if(hlStart) previewHL(c); break;
    }
    // Note tooltip on hover
    showNoteTooltip(c, e);
}

function onMouseUp(e){
    var c = getCoords(e);
    switch(currentTool){
        case 'draw': if(isDrawing) endDraw(); break;
        case 'line': if(lineStart) endLine(c); break;
        case 'highlight': if(hlStart) endHL(c); break;
    }
}

// ========== TEXT TOOL ==========
function handleTextClick(c){
    closeTextInput();
    var viewer = document.getElementById('viewer');
    var rect = overlayCanvas.getBoundingClientRect();
    var ratioX = rect.width / overlayCanvas.width;
    var ratioY = rect.height / overlayCanvas.height;

    var div = document.createElement('div');
    div.className = 'tinput';
    div.style.left = (c.x * ratioX) + 'px';
    div.style.top = (c.y * ratioY) + 'px';

    var ta = document.createElement('textarea');
    var fs = parseInt(document.getElementById('toolFontSize').value)||16;
    ta.style.fontSize = (fs * ratioY)+'px';
    ta.style.color = document.getElementById('toolColor').value;
    ta.rows = 1;
    ta.cols = 15;
    div.appendChild(ta);
    viewer.appendChild(div);
    ta.focus();

    activeTextInput = {div:div, ta:ta, cx:c.x, cy:c.y};

    ta.addEventListener('keydown', function(e){
        if(e.key==='Enter' && !e.shiftKey){
            e.preventDefault();
            commitTextInput();
        }
        if(e.key==='Escape') closeTextInput();
    });
    ta.addEventListener('blur', function(){
        setTimeout(commitTextInput, 100);
    });
}

function commitTextInput(){
    if(!activeTextInput) return;
    var text = activeTextInput.ta.value.trim();
    if(text){
        var fs = parseInt(document.getElementById('toolFontSize').value)||16;
        var color = document.getElementById('toolColor').value;
        addAnnotation(currentPage, {type:'text', x:activeTextInput.cx, y:activeTextInput.cy, text:text, fontSize:fs, color:color});
        renderOverlay();
    }
    closeTextInput();
}

function closeTextInput(){
    if(activeTextInput){
        if(activeTextInput.div.parentNode) activeTextInput.div.parentNode.removeChild(activeTextInput.div);
        activeTextInput = null;
    }
}

// ========== DRAW TOOL ==========
function startDraw(c){
    isDrawing = true;
    drawPoints = [c];
}

function continueDraw(c){
    drawPoints.push(c);
    renderOverlay();
    // Draw current path
    overlayCtx.save();
    overlayCtx.strokeStyle = document.getElementById('toolColor').value;
    overlayCtx.lineWidth = parseInt(document.getElementById('toolSize').value)||2;
    overlayCtx.lineCap = 'round';
    overlayCtx.lineJoin = 'round';
    overlayCtx.beginPath();
    overlayCtx.moveTo(drawPoints[0].x, drawPoints[0].y);
    for(var i=1;i<drawPoints.length;i++) overlayCtx.lineTo(drawPoints[i].x, drawPoints[i].y);
    overlayCtx.stroke();
    overlayCtx.restore();
}

function endDraw(){
    isDrawing = false;
    if(drawPoints.length>=2){
        addAnnotation(currentPage, {
            type:'draw',
            points: drawPoints.slice(),
            color: document.getElementById('toolColor').value,
            lineWidth: parseInt(document.getElementById('toolSize').value)||2
        });
    }
    drawPoints = [];
    renderOverlay();
}

// ========== LINE TOOL ==========
function previewLine(c){
    renderOverlay();
    overlayCtx.save();
    overlayCtx.strokeStyle = document.getElementById('toolColor').value;
    overlayCtx.lineWidth = parseInt(document.getElementById('toolSize').value)||2;
    overlayCtx.lineCap = 'round';
    overlayCtx.beginPath();
    overlayCtx.moveTo(lineStart.x, lineStart.y);
    overlayCtx.lineTo(c.x, c.y);
    overlayCtx.stroke();
    overlayCtx.restore();
}

function endLine(c){
    var dx = c.x-lineStart.x, dy = c.y-lineStart.y;
    if(Math.sqrt(dx*dx+dy*dy)>5){
        addAnnotation(currentPage, {
            type:'line', x1:lineStart.x, y1:lineStart.y, x2:c.x, y2:c.y,
            color: document.getElementById('toolColor').value,
            lineWidth: parseInt(document.getElementById('toolSize').value)||2
        });
    }
    lineStart = null;
    renderOverlay();
}

// ========== HIGHLIGHT TOOL ==========
function previewHL(c){
    renderOverlay();
    var x = Math.min(hlStart.x, c.x), y = Math.min(hlStart.y, c.y);
    var w = Math.abs(c.x - hlStart.x), h = Math.abs(c.y - hlStart.y);
    overlayCtx.save();
    overlayCtx.fillStyle = document.getElementById('toolColor').value + '59'; // ~35% opacity
    overlayCtx.fillRect(x,y,w,h);
    overlayCtx.restore();
}

function endHL(c){
    var x = Math.min(hlStart.x, c.x), y = Math.min(hlStart.y, c.y);
    var w = Math.abs(c.x - hlStart.x), h = Math.abs(c.y - hlStart.y);
    if(w>5 && h>5){
        addAnnotation(currentPage, {
            type:'highlight', x:x, y:y, w:w, h:h,
            color: document.getElementById('toolColor').value + '59'
        });
    }
    hlStart = null;
    renderOverlay();
}

// ========== SIGNATURE TOOL ==========
function initSignCanvas(){
    var c = document.getElementById('signCanvas');
    c.width = c.offsetWidth;
    c.height = c.offsetHeight;
    var ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    ctx.fillStyle = '#fff';
    ctx.fillRect(0,0,c.width,c.height);
    signPoints = [];
    signDrawing = false;
}

function signStart(e){
    signDrawing = true;
    var c = document.getElementById('signCanvas');
    var rect = c.getBoundingClientRect();
    signPoints = [{x: e.clientX-rect.left, y: e.clientY-rect.top}];
}

function signMove(e){
    if(!signDrawing) return;
    var c = document.getElementById('signCanvas');
    var rect = c.getBoundingClientRect();
    var p = {x: e.clientX-rect.left, y: e.clientY-rect.top};
    signPoints.push(p);
    var ctx = c.getContext('2d');
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    if(signPoints.length>=2){
        ctx.beginPath();
        ctx.moveTo(signPoints[signPoints.length-2].x, signPoints[signPoints.length-2].y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
    }
}

function signEnd(){ signDrawing = false; }

function clearSign(){ initSignCanvas(); }

function useSign(){
    var c = document.getElementById('signCanvas');
    pendingSign = c.toDataURL('image/png');
    closeModal('sign');
    // Tool stays as 'sign', user clicks to place
}

function placeSign(c){
    if(!pendingSign) return;
    var img = new Image();
    img.onload = function(){
        var w = 200, h = 80;
        addAnnotation(currentPage, {type:'sign', x:c.x-w/2, y:c.y-h/2, w:w, h:h, dataUrl:pendingSign, img:img});
        renderOverlay();
        pendingSign = null;
        selectTool('none');
    };
    img.src = pendingSign;
}

// ========== IMAGE TOOL ==========
function handleImgFile(input){
    var file = input.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(e){
        pendingImg = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function placeImg(c){
    if(!pendingImg) return;
    var img = new Image();
    img.onload = function(){
        var maxW = 250, maxH = 250;
        var w = img.naturalWidth, h = img.naturalHeight;
        if(w>maxW){ h = h*(maxW/w); w=maxW; }
        if(h>maxH){ w = w*(maxH/h); h=maxH; }
        addAnnotation(currentPage, {type:'image', x:c.x-w/2, y:c.y-h/2, w:w, h:h, dataUrl:pendingImg, img:img});
        renderOverlay();
        pendingImg = null;
        selectTool('none');
    };
    img.src = pendingImg;
}

// ========== NOTE TOOL ==========
function handleNoteClick(c){
    noteClickPos = c;
    document.getElementById('noteText').value = '';
    openModal('note');
}

function confirmNote(){
    var text = document.getElementById('noteText').value.trim();
    if(!text || !noteClickPos) { closeModal('note'); return; }
    addAnnotation(currentPage, {type:'note', x:noteClickPos.x, y:noteClickPos.y, text:text, color:'#fbbf24'});
    closeModal('note');
    renderOverlay();
    noteClickPos = null;
}

function showNoteTooltip(c, e){
    var anns = edits[currentPage]||[];
    var found = null;
    for(var i=anns.length-1;i>=0;i--){
        if(anns[i].type==='note' && Math.abs(c.x-anns[i].x)<15 && Math.abs(c.y-anns[i].y)<15){
            found = anns[i];
            break;
        }
    }
    if(found){
        var rect = overlayCanvas.getBoundingClientRect();
        var rx = overlayCanvas.width/rect.width;
        noteTooltipEl.textContent = found.text;
        noteTooltipEl.style.display = 'block';
        noteTooltipEl.style.left = (c.x/rx + 15) + 'px';
        noteTooltipEl.style.top = (c.y/(overlayCanvas.height/rect.height) - 10) + 'px';
    } else {
        noteTooltipEl.style.display = 'none';
    }
}

// ========== ERASER TOOL ==========
function handleErase(c){
    var anns = edits[currentPage]||[];
    for(var i=anns.length-1;i>=0;i--){
        if(hitTest(c.x, c.y, anns[i])){
            removeAnnotation(currentPage, i);
            renderOverlay();
            return;
        }
    }
}

function hitTest(x, y, a){
    var margin = 8;
    switch(a.type){
        case 'text':
            var tw = (a.text||'').length * a.fontSize * 0.6;
            var th = a.fontSize * ((a.text||'').split('\n').length);
            return x>=a.x-margin && x<=a.x+tw+margin && y>=a.y-margin && y<=a.y+th+margin;
        case 'draw':
            if(!a.points) return false;
            for(var i=0;i<a.points.length;i++){
                if(Math.abs(a.points[i].x-x)<10 && Math.abs(a.points[i].y-y)<10) return true;
            }
            return false;
        case 'line':
            return distToSeg(x,y,a.x1,a.y1,a.x2,a.y2) < 10;
        case 'highlight':
            return x>=a.x-margin && x<=a.x+a.w+margin && y>=a.y-margin && y<=a.y+a.h+margin;
        case 'image': case 'sign':
            return x>=a.x-margin && x<=a.x+a.w+margin && y>=a.y-margin && y<=a.y+a.h+margin;
        case 'note':
            return Math.abs(x-a.x)<18 && Math.abs(y-a.y)<18;
    }
    return false;
}

function distToSeg(px,py,x1,y1,x2,y2){
    var dx=x2-x1,dy=y2-y1;
    var len2=dx*dx+dy*dy;
    if(len2===0) return Math.sqrt((px-x1)*(px-x1)+(py-y1)*(py-y1));
    var t=Math.max(0,Math.min(1,((px-x1)*dx+(py-y1)*dy)/len2));
    var cx=x1+t*dx, cy=y1+t*dy;
    return Math.sqrt((px-cx)*(px-cx)+(py-cy)*(py-cy));
}

// ========== UNDO / REDO ==========
function addAnnotation(pg, ann){
    if(!edits[pg]) edits[pg]=[];
    edits[pg].push(ann);
    undoStack.push({action:'add', page:pg, ann:ann});
    redoStack = [];
    updateUndoRedoBtns();
}

function removeAnnotation(pg, idx){
    if(!edits[pg]) return;
    var ann = edits[pg].splice(idx,1)[0];
    undoStack.push({action:'remove', page:pg, ann:ann, idx:idx});
    redoStack = [];
    updateUndoRedoBtns();
}

function doUndo(){
    if(undoStack.length===0) return;
    var act = undoStack.pop();
    if(act.action==='add'){
        var arr = edits[act.page]||[];
        var i = arr.lastIndexOf(act.ann);
        if(i>=0) arr.splice(i,1);
    } else if(act.action==='remove'){
        if(!edits[act.page]) edits[act.page]=[];
        edits[act.page].splice(act.idx,0,act.ann);
    }
    redoStack.push(act);
    updateUndoRedoBtns();
    renderOverlay();
}

function doRedo(){
    if(redoStack.length===0) return;
    var act = redoStack.pop();
    if(act.action==='add'){
        if(!edits[act.page]) edits[act.page]=[];
        edits[act.page].push(act.ann);
    } else if(act.action==='remove'){
        var arr = edits[act.page]||[];
        if(act.idx<arr.length) arr.splice(act.idx,1);
        else arr.pop();
    }
    undoStack.push(act);
    updateUndoRedoBtns();
    renderOverlay();
}

function updateUndoRedoBtns(){
    document.getElementById('undoBtn').disabled = undoStack.length===0;
    document.getElementById('redoBtn').disabled = redoStack.length===0;
}

// ========== NAVIGATION ==========
function goPage(delta){
    var pg = currentPage + delta;
    if(pg<1||pg>totalPages) return;
    currentPage = pg;
    closeTextInput();
    renderPage(pg);
}

function changeZoom(delta){
    var levels = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0, 3.0];
    var idx = levels.indexOf(zoomLevel);
    if(idx===-1){ idx = 2; } // default 1.0
    idx += delta;
    if(idx<0||idx>=levels.length) return;
    zoomLevel = levels[idx];
    renderPage(currentPage);
}

function closeEditor(){
    document.getElementById('editorView').style.display = 'none';
    document.getElementById('homeView').style.display = 'flex';
    pdfDoc = null;
    originalFile = null;
    edits = {};
    undoStack = [];
    redoStack = [];
    currentTool = 'none';
    document.querySelectorAll('.tb[data-tool]').forEach(function(b){ b.classList.remove('active'); });
    document.getElementById('fileInput').value = '';
}

// ========== SAVE & DOWNLOAD ==========
function saveAndDownload(){
    if(!pdfDoc || !originalFile){ alert('Tidak ada PDF untuk disimpan'); return; }

    var hasEdits = false;
    for(var k in edits){ if(edits[k]&&edits[k].length>0){ hasEdits=true; break; } }
    if(!hasEdits){
        alert('Tidak ada perubahan untuk disimpan');
        return;
    }

    var formData = new FormData();
    formData.append('file', originalFile);
    formData.append('editMode', 'add');

    // We need to generate overlay images for each page with edits
    // We'll do them sequentially since we need the correct viewport
    var pagesToProcess = [];
    for(var pg in edits){
        if(edits[pg] && edits[pg].length>0) pagesToProcess.push(parseInt(pg));
    }

    var overlayBlobs = [];
    var processed = 0;

    function processNextPage(){
        if(processed >= pagesToProcess.length){
            // All overlays generated, now upload
            for(var i=0;i<overlayBlobs.length;i++){
                formData.append('overlays', overlayBlobs[i].blob, overlayBlobs[i].name);
            }
            doUpload(formData);
            return;
        }

        var pg = pagesToProcess[processed];
        // Get viewport for this page - render at base scale (not zoom)
        pdfDoc.getPage(pg).then(function(page){
            var vp = page.getViewport({scale: baseScale});
            var tc = document.createElement('canvas');
            tc.width = vp.width;
            tc.height = vp.height;
            var tctx = tc.getContext('2d');

            // Temporarily render annotations at base scale coordinates
            // Since annotations were recorded at (baseScale * zoomLevel), we need to scale them
            var scaleFactor = baseScale / (baseScale * zoomLevel);
            if(zoomLevel !== 1.0){
                tctx.save();
                tctx.scale(scaleFactor, scaleFactor);
            }
            renderAnnsToCtx(tctx, pg);
            if(zoomLevel !== 1.0) tctx.restore();

            tc.toBlob(function(blob){
                overlayBlobs.push({
                    blob: blob,
                    name: 'overlay-page-'+pg+'-cw-'+tc.width+'-ch-'+tc.height+'.png'
                });
                processed++;
                processNextPage();
            }, 'image/png');
        });
    }

    processNextPage();
}

function doUpload(formData){
    var saveBtn = document.querySelector('.tb-save');
    var origText = saveBtn.innerHTML;
    saveBtn.innerHTML = 'Saving...';
    saveBtn.disabled = true;

    fetch(basePath + '/api/edit', {method:'POST', body:formData})
    .then(function(r){ return r.json(); })
    .then(function(data){
        saveBtn.innerHTML = origText;
        saveBtn.disabled = false;
        if(data.success){
            // Download
            var a = document.createElement('a');
            a.href = basePath + '/api/download/' + data.file;
            a.download = 'edited-' + (originalFile.name||'document.pdf');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } else {
            alert('Gagal menyimpan: '+(data.error||'Unknown error'));
        }
    })
    .catch(function(err){
        saveBtn.innerHTML = origText;
        saveBtn.disabled = false;
        alert('Error: '+err.message);
    });
}

// ========== PRINT ==========
function printDoc(){
    if(!pdfDoc) return;
    // Render current page to a printable window
    var w = window.open('','_blank');
    w.document.write('<html><head><title>Print</title><style>@page{margin:0}body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh}img{max-width:100%;height:auto}</style></head><body>');

    // Render PDF page + overlays to a combined canvas
    var combined = document.createElement('canvas');
    combined.width = pdfCanvas.width;
    combined.height = pdfCanvas.height;
    var cctx = combined.getContext('2d');
    cctx.drawImage(pdfCanvas, 0, 0);
    cctx.drawImage(overlayCanvas, 0, 0);

    var dataUrl = combined.toDataURL('image/png');
    w.document.write('<img src="'+dataUrl+'">');
    w.document.write('</body></html>');
    w.document.close();
    setTimeout(function(){ w.print(); }, 300);
}

// ========== MODAL HELPERS ==========
function openModal(name){
    document.getElementById(name+'Modal').classList.add('show');
}

function closeModal(name){
    document.getElementById(name+'Modal').classList.remove('show');
    // Reset status
    var st = document.getElementById(name+'St');
    if(st){ st.className='mst'; st.textContent=''; }
}

function showSt(id, msg, type){
    var el = document.getElementById(id);
    el.textContent = msg;
    el.className = 'mst show ' + type;
}

// ========== MERGE ==========
function doMerge(){
    var input = document.getElementById('mergeFiles');
    if(!input.files||input.files.length<2){
        showSt('mergeSt','Minimal 2 file PDF','err');
        return;
    }
    var fd = new FormData();
    for(var i=0;i<input.files.length;i++) fd.append('files', input.files[i]);

    showSt('mergeSt','Menggabungkan PDF...','ld');

    fetch(basePath+'/api/merge',{method:'POST',body:fd})
    .then(function(r){ return r.json(); })
    .then(function(data){
        if(data.success){
            showSt('mergeSt','Berhasil! Mengunduh...','ok');
            downloadResult(data.download, data.file);
            setTimeout(function(){ closeModal('merge'); }, 1500);
        } else {
            showSt('mergeSt', data.error||'Gagal merge','err');
        }
    })
    .catch(function(e){ showSt('mergeSt','Error: '+e.message,'err'); });
}

// ========== SPLIT ==========
function doSplit(){
    var input = document.getElementById('splitFile');
    var pages = document.getElementById('splitPages').value.trim();
    if(!input.files||!input.files[0]){ showSt('splitSt','Pilih file PDF','err'); return; }
    if(!pages){ showSt('splitSt','Masukkan halaman','err'); return; }

    var fd = new FormData();
    fd.append('file', input.files[0]);
    fd.append('pages', pages);

    showSt('splitSt','Memisahkan PDF...','ld');

    fetch(basePath+'/api/split',{method:'POST',body:fd})
    .then(function(r){ return r.json(); })
    .then(function(data){
        if(data.success){
            showSt('splitSt','Berhasil! Mengunduh...','ok');
            downloadResult(data.download, data.file);
            setTimeout(function(){ closeModal('split'); }, 1500);
        } else {
            showSt('splitSt', data.error||'Gagal split','err');
        }
    })
    .catch(function(e){ showSt('splitSt','Error: '+e.message,'err'); });
}

// ========== COMPRESS ==========
function doCompress(){
    var input = document.getElementById('compressFile');
    var level = document.getElementById('compressLevel').value;
    if(!input.files||!input.files[0]){ showSt('compressSt','Pilih file PDF','err'); return; }

    var fd = new FormData();
    fd.append('file', input.files[0]);
    fd.append('level', level);

    showSt('compressSt','Mengompres PDF...','ld');

    fetch(basePath+'/api/compress',{method:'POST',body:fd})
    .then(function(r){ return r.json(); })
    .then(function(data){
        if(data.success){
            showSt('compressSt','Berhasil! Mengunduh...','ok');
            downloadResult(data.download, data.file);
            setTimeout(function(){ closeModal('compress'); }, 1500);
        } else {
            showSt('compressSt', data.error||'Gagal compress','err');
        }
    })
    .catch(function(e){ showSt('compressSt','Error: '+e.message,'err'); });
}

// ========== CONVERT ==========
function doConvert(){
    var input = document.getElementById('convertFile');
    var format = document.getElementById('convertFormat').value;
    if(!input.files||!input.files[0]){ showSt('convertSt','Pilih file PDF','err'); return; }

    var fd = new FormData();
    fd.append('file', input.files[0]);
    fd.append('format', format);

    showSt('convertSt','Mengkonversi PDF...','ld');

    fetch(basePath+'/api/convert',{method:'POST',body:fd})
    .then(function(r){ return r.json(); })
    .then(function(data){
        if(data.success){
            if(format==='text' && data.content){
                showSt('convertSt','Berhasil! Teks:\n'+data.content.substring(0,200)+'...','ok');
                if(data.download) downloadResult(data.download, data.file);
            } else if(data.downloads){
                showSt('convertSt','Berhasil! Mengunduh '+data.downloads.length+' gambar...','ok');
                data.downloads.forEach(function(dl,i){
                    setTimeout(function(){ downloadResult(dl, data.files[i]); }, i*500);
                });
            } else if(data.download){
                showSt('convertSt','Berhasil! Mengunduh...','ok');
                downloadResult(data.download, data.file);
            }
            setTimeout(function(){ closeModal('convert'); }, 2000);
        } else {
            showSt('convertSt', data.error||'Gagal convert','err');
        }
    })
    .catch(function(e){ showSt('convertSt','Error: '+e.message,'err'); });
}

// ========== DOWNLOAD HELPER ==========
function downloadResult(url, filename){
    var a = document.createElement('a');
    a.href = basePath + url;
    a.download = filename || 'download';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e){
    if(!pdfDoc) return;
    if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
    if(e.ctrlKey && e.key==='z'){ e.preventDefault(); doUndo(); }
    if(e.ctrlKey && e.key==='y'){ e.preventDefault(); doRedo(); }
    if(e.key==='Escape'){ selectTool('none'); closeTextInput(); }
});
</script>
</body>
</html>
