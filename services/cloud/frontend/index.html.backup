<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HarywangCloud</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #0f1117;
            color: #e5e5e5;
            min-height: 100vh;
        }

        /* ============ HEADER ============ */

        .header {
            padding: 16px 24px;
            border-bottom: 1px solid #1e2030;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: rgba(15,17,23,.95);
            backdrop-filter: blur(12px);
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left .logo {
            width: 32px; height: 32px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; color: #fff;
        }

        .header-left h1 {
            font-size: 17px;
            font-weight: 600;
        }

        .storage-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #737373;
        }

        .storage-info .bar {
            width: 80px; height: 5px;
            background: #1e2030;
            border-radius: 3px;
            overflow: hidden;
        }

        .storage-info .bar-fill {
            height: 100%;
            background: #10b981;
            border-radius: 3px;
            transition: width .4s;
        }

        /* ============ TOOLBAR ============ */

        .toolbar {
            padding: 10px 24px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #1a1d2a;
            flex-wrap: wrap;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 0;
            flex-wrap: wrap;
            font-size: 13px;
        }

        .breadcrumb a {
            color: #60a5fa;
            text-decoration: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background .15s;
        }

        .breadcrumb a:hover { background: rgba(96,165,250,.1); }

        .breadcrumb a.current {
            color: #e5e5e5;
            cursor: default;
        }

        .breadcrumb a.current:hover { background: transparent; }

        .breadcrumb .sep {
            color: #404050;
            font-size: 11px;
        }

        .toolbar-btns {
            display: flex;
            gap: 6px;
        }

        .tb {
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #2a2d3a;
            background: #181b26;
            color: #c0c0c0;
            transition: all .15s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tb:hover { background: #22263a; border-color: #3a3d4a; color: #fff; }

        .tb-green {
            background: #10b981;
            border-color: #10b981;
            color: #fff;
        }

        .tb-green:hover { background: #059669; border-color: #059669; }

        /* ============ UPLOAD ZONE ============ */

        .upload-zone {
            margin: 12px 24px;
            border: 2px dashed #1e2030;
            border-radius: 10px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all .25s;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #10b981;
            background: rgba(16,185,129,.04);
        }

        .upload-zone p { color: #555; font-size: 13px; }
        .upload-zone .sub { font-size: 11px; color: #333; margin-top: 3px; }

        .upload-progress {
            display: none;
            margin: 0 24px 8px;
            background: #181b26;
            border-radius: 8px;
            padding: 10px 14px;
        }

        .upload-progress.show { display: block; }

        .upload-progress .bar-w {
            width: 100%;
            height: 6px;
            background: #1e2030;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .upload-progress .bar-f {
            height: 100%;
            background: #10b981;
            border-radius: 3px;
            transition: width .2s;
            width: 0%;
        }

        .upload-progress .info { font-size: 11px; color: #666; }

        /* ============ EXPLORER TABLE ============ */

        .explorer {
            padding: 0 24px 24px;
        }

        .explorer-table {
            width: 100%;
            border-collapse: collapse;
        }

        .explorer-table thead th {
            text-align: left;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: .5px;
            border-bottom: 1px solid #1e2030;
            position: sticky;
            top: 55px;
            background: #0f1117;
            z-index: 10;
            user-select: none;
        }

        .explorer-table thead th:first-child { padding-left: 16px; }

        .explorer-table tbody tr {
            border-bottom: 1px solid #141620;
            transition: background .1s;
            cursor: pointer;
        }

        .explorer-table tbody tr:hover {
            background: #161924;
        }

        .explorer-table td {
            padding: 10px 12px;
            font-size: 13px;
            vertical-align: middle;
        }

        .explorer-table td:first-child { padding-left: 16px; }

        .cell-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cell-name .icon {
            width: 32px; height: 32px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .cell-name .icon.folder-icon {
            background: rgba(234,179,8,.12);
        }

        .cell-name .icon.file-icon {
            background: rgba(96,165,250,.1);
        }

        .cell-name .name-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }

        .cell-name .lock-badge {
            font-size: 10px;
            background: rgba(234,179,8,.15);
            color: #eab308;
            padding: 1px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .cell-date, .cell-size, .cell-type {
            color: #666;
            white-space: nowrap;
        }

        .cell-actions {
            opacity: 0;
            transition: opacity .15s;
            display: flex;
            gap: 4px;
        }

        tr:hover .cell-actions { opacity: 1; }

        .act-btn {
            width: 28px; height: 28px;
            border-radius: 6px;
            border: none;
            background: rgba(255,255,255,.04);
            color: #888;
            font-size: 13px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all .1s;
        }

        .act-btn:hover { background: rgba(255,255,255,.1); color: #fff; }
        .act-btn.del:hover { background: rgba(239,68,68,.15); color: #ef4444; }

        /* Empty */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #444;
        }

        .empty-state .e-icon { font-size: 40px; margin-bottom: 12px; opacity: .5; }
        .empty-state p { font-size: 14px; }

        /* ============ MODALS ============ */

        .modal-bg {
            position: fixed; inset: 0;
            background: rgba(0,0,0,.55);
            display: flex; align-items: center; justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all .2s;
        }

        .modal-bg.show { opacity: 1; visibility: visible; }

        .modal {
            background: #181b26;
            border: 1px solid #2a2d3a;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 420px;
            transform: scale(.95);
            transition: transform .2s;
        }

        .modal-bg.show .modal { transform: scale(1); }

        .modal h3 { font-size: 16px; margin-bottom: 16px; font-weight: 600; }

        .modal .field { margin-bottom: 14px; }

        .modal label {
            display: block;
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .modal input[type="text"],
        .modal input[type="password"] {
            width: 100%;
            padding: 10px 12px;
            background: #0f1117;
            border: 1px solid #2a2d3a;
            border-radius: 7px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: border-color .15s;
        }

        .modal input:focus { border-color: #10b981; }
        .modal input::placeholder { color: #3a3d4a; }

        .modal .hint { font-size: 11px; color: #444; margin-top: 3px; }

        .modal .radio-group {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }

        .modal .radio-opt {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #2a2d3a;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #888;
            transition: all .15s;
        }

        .modal .radio-opt:hover { border-color: #3a3d4a; color: #ccc; }

        .modal .radio-opt.selected {
            border-color: #10b981;
            background: rgba(16,185,129,.08);
            color: #10b981;
        }

        .modal .m-error {
            background: #2a1215;
            border: 1px solid #5c1d24;
            color: #fca5a5;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 12px;
            display: none;
        }

        .modal .m-error.show { display: block; }

        .modal .m-success {
            background: rgba(16,185,129,.1);
            border: 1px solid rgba(16,185,129,.3);
            color: #6ee7b7;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 12px;
            display: none;
        }

        .modal .m-success.show { display: block; }

        .modal-btns {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 4px;
        }

        .modal-btns button {
            padding: 8px 18px;
            border-radius: 7px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity .15s;
        }

        .modal-btns .m-cancel { background: #2a2d3a; color: #999; }
        .modal-btns .m-cancel:hover { background: #333; }
        .modal-btns .m-ok { background: #10b981; color: #fff; }
        .modal-btns .m-ok:hover { opacity: .85; }
        .modal-btns .m-del { background: #dc2626; color: #fff; }
        .modal-btns .m-del:hover { opacity: .85; }

        /* ============ TOAST ============ */

        .toast-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .toast {
            background: #1e2030;
            border: 1px solid #2a2d3a;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 12px;
            color: #ddd;
            animation: slideUp .25s;
        }

        .toast.ok { border-color: #065f46; }
        .toast.err { border-color: #7f1d1d; color: #fca5a5; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* ============ FILE PREVIEW MODAL ============ */
        .preview-modal-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,.92);
            z-index: 250;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .preview-modal-bg.show { display: flex; }

        .preview-modal {
            background: #181b26;
            border: 1px solid #2a2d3a;
            border-radius: 12px;
            width: 90vw;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .preview-header {
            padding: 14px 18px;
            border-bottom: 1px solid #2a2d3a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .preview-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: #e5e5e5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 600px;
        }

        .preview-header-btns {
            display: flex;
            gap: 8px;
        }

        .preview-header-btns button {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid #2a2d3a;
            background: #1e2030;
            color: #c0c0c0;
            font-size: 12px;
            cursor: pointer;
            transition: all .15s;
        }

        .preview-header-btns button:hover {
            background: #22263a;
            border-color: #3a3d4a;
            color: #fff;
        }

        .preview-header-btns .btn-download {
            background: #10b981;
            border-color: #10b981;
            color: #fff;
        }

        .preview-header-btns .btn-download:hover {
            background: #059669;
            border-color: #059669;
        }

        .preview-content {
            flex: 1;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #0f1117;
        }

        .preview-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .preview-content video,
        .preview-content audio {
            max-width: 100%;
            border-radius: 8px;
        }

        .preview-content video {
            max-height: 70vh;
        }

        .preview-content audio {
            width: 100%;
            max-width: 600px;
        }

        .preview-content iframe {
            width: 100%;
            height: 75vh;
            border: none;
            border-radius: 8px;
            background: #fff;
        }

        .preview-content pre {
            background: #1e2030;
            color: #e5e5e5;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            width: 100%;
            max-height: 70vh;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .preview-unsupported {
            text-align: center;
            color: #737373;
            padding: 40px;
        }

        .preview-unsupported .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* ============ RESPONSIVE ============ */

        @media (max-width: 640px) {
            .header { padding: 12px 14px; }
            .toolbar { padding: 8px 14px; }
            .upload-zone { margin: 8px 14px; padding: 18px; }
            .explorer { padding: 0 14px 14px; }
            .explorer-table td:nth-child(3),
            .explorer-table th:nth-child(3),
            .explorer-table td:nth-child(4),
            .explorer-table th:nth-child(4) { display: none; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <div class="logo">&#9729;</div>
            <h1>HarywangCloud</h1>
        </div>
        <div class="storage-info">
            <div class="bar"><div class="bar-fill" id="storageBarFill"></div></div>
            <span id="storageText">--</span>
        </div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
        <div class="breadcrumb" id="breadcrumb"><a class="current">Root</a></div>
        <div class="toolbar-btns">
            <button class="tb" onclick="showNewFolderModal()">+ Folder</button>
            <button class="tb tb-green" onclick="triggerUpload()">Upload</button>
        </div>
    </div>

    <!-- UPLOAD ZONE -->
    <div class="upload-zone" id="uploadZone">
        <p>Klik atau drag file ke sini untuk upload</p>
        <div class="sub">Maks 500MB per file</div>
    </div>

    <div class="upload-progress" id="uploadProgress">
        <div class="bar-w"><div class="bar-f" id="uploadBarFill"></div></div>
        <div class="info" id="uploadInfo">Mengupload...</div>
    </div>

    <!-- EXPLORER -->
    <div class="explorer">
        <table class="explorer-table" id="explorerTable">
            <thead>
                <tr>
                    <th style="width:50%;">Nama</th>
                    <th style="width:18%;">Tanggal</th>
                    <th style="width:12%;">Ukuran</th>
                    <th style="width:12%;">Tipe</th>
                    <th style="width:8%;"></th>
                </tr>
            </thead>
            <tbody id="explorerBody"></tbody>
        </table>
        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="e-icon">&#128193;</div>
            <p>Folder ini kosong</p>
        </div>
    </div>

    <!-- NEW FOLDER MODAL -->
    <div class="modal-bg" id="folderModal">
        <div class="modal">
            <h3>Buat Folder Baru</h3>
            <div class="m-error" id="folderError"></div>
            <div class="field">
                <label>Nama Folder</label>
                <input type="text" id="folderNameInput" placeholder="Nama folder" maxlength="100">
            </div>
            <label style="font-size:12px;color:#888;margin-bottom:6px;display:block;">Keamanan Folder</label>
            <div class="radio-group">
                <div class="radio-opt selected" id="optPwd" onclick="setAuthType('password')">Password</div>
                <div class="radio-opt" id="optPin" onclick="setAuthType('pin')">PIN</div>
            </div>
            <div class="field" id="pwdField">
                <label>Password</label>
                <input type="password" id="folderPassword" placeholder="Masukkan password" autocomplete="off">
                <div class="hint">Bisa pakai password apa saja</div>
            </div>
            <div class="field" id="pinField" style="display:none;">
                <label>PIN</label>
                <input type="password" id="folderPin" placeholder="Masukkan PIN" inputmode="numeric">
                <div class="hint">Bisa pakai angka apa saja</div>
            </div>
            <div class="modal-btns">
                <button class="m-cancel" onclick="closeFolderModal()">Batal</button>
                <button class="m-ok" onclick="createFolder()">Buat</button>
            </div>
        </div>
    </div>

    <!-- UNLOCK MODAL -->
    <div class="modal-bg" id="unlockModal">
        <div class="modal">
            <h3 id="unlockTitle">Buka Folder</h3>
            <div class="m-error" id="unlockError"></div>
            <div class="field">
                <label id="unlockLabel">Password</label>
                <input type="password" id="unlockInput" placeholder="Masukkan password" autocomplete="off">
            </div>
            <div class="modal-btns">
                <button class="m-cancel" onclick="closeUnlockModal()">Batal</button>
                <button class="m-ok" onclick="doUnlock()">Buka</button>
            </div>
            <div style="text-align:center;margin-top:12px;">
                <a href="javascript:void(0)" onclick="showResetPassword()" style="color:#60a5fa;font-size:12px;text-decoration:underline;">Lupa Password/PIN?</a>
            </div>
        </div>
    </div>

    <!-- RESET PASSWORD MODAL -->
    <div class="modal-bg" id="resetModal">
        <div class="modal">
            <h3>Reset Password/PIN</h3>
            <div class="m-error" id="resetError"></div>
            <div class="m-success" id="resetSuccess"></div>
            <p style="color:#888;font-size:13px;margin-bottom:16px;">Masukkan password/PIN baru untuk folder "<span id="resetFolderName"></span>"</p>
            <div class="field">
                <label id="resetLabel">Password/PIN Baru</label>
                <input type="password" id="resetInput" placeholder="Masukkan password/PIN baru" autocomplete="off">
            </div>
            <div class="modal-btns">
                <button class="m-cancel" onclick="closeResetModal()">Batal</button>
                <button class="m-ok" onclick="doResetPassword()">Reset</button>
            </div>
        </div>
    </div>

    <!-- DELETE MODAL -->
    <div class="modal-bg" id="deleteModal">
        <div class="modal">
            <h3 id="deleteTitle">Hapus?</h3>
            <p style="color:#888;font-size:13px;margin-bottom:16px;" id="deleteMsg"></p>
            <div class="modal-btns">
                <button class="m-cancel" onclick="closeDeleteModal()">Batal</button>
                <button class="m-del" onclick="confirmDelete()">Hapus</button>
            </div>
        </div>
    </div>

    <!-- FILE PREVIEW MODAL -->
    <div class="preview-modal-bg" id="previewModal">
        <div class="preview-modal">
            <div class="preview-header">
                <h3 id="previewTitle">Preview File</h3>
                <div class="preview-header-btns">
                    <button class="btn-download" onclick="downloadCurrentPreview()">&#11015; Download</button>
                    <button onclick="closePreview()">‚úï Tutup</button>
                </div>
            </div>
            <div class="preview-content" id="previewContent">
                <div class="preview-unsupported">
                    <div class="icon">üìÑ</div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast-box" id="toastBox"></div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="fileInput" style="display:none;" multiple>

    <script>
        // ============ STATE ============
        var currentFolder = null;
        var folderPath = [];
        var folderTokens = {};  // { folderId: token }
        var deleteTarget = null;
        var unlockTarget = null;
        var newFolderAuthType = 'password';
        var lockTimers = {};  // folderId ‚Üí setTimeout ID for re-locking
        var currentPreviewFile = null;  // { id, name, mimetype }

        // ============ API ============
        function api(endpoint, opts) {
            opts = opts || {};
            var headers = opts.headers || {};
            // Attach folder token if we have one for the current folder
            if (currentFolder && folderTokens[currentFolder]) {
                headers['X-Folder-Token'] = folderTokens[currentFolder];
            }
            if (opts.json) {
                headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(opts.json);
                delete opts.json;
            }
            opts.headers = headers;
            return fetch('api/' + endpoint, opts);
        }

        // ============ LOAD ============
        async function loadFiles() {
            try {
                var url = currentFolder ? 'files?folder=' + currentFolder : 'files';
                var headers = {};
                if (currentFolder && folderTokens[currentFolder]) {
                    headers['X-Folder-Token'] = folderTokens[currentFolder];
                }
                var r = await fetch('api/' + url, { headers: headers });
                if (r.status === 403) {
                    // Folder locked, should not happen if we always unlock first
                    toast('Folder terkunci', 'err');
                    return;
                }
                var data = await r.json();
                renderExplorer(data.folders || [], data.files || []);
                updateBreadcrumb();
            } catch (e) {
                toast('Gagal memuat', 'err');
            }
        }

        async function loadStorage() {
            try {
                var r = await fetch('api/storage');
                if (!r.ok) return;
                var data = await r.json();
                var pct = (data.used / data.total * 100).toFixed(1);
                document.getElementById('storageBarFill').style.width = pct + '%';
                document.getElementById('storageText').textContent = fmtSize(data.used) + ' / ' + fmtSize(data.total);
            } catch (e) {}
        }

        // ============ RENDER EXPLORER ============
        function renderExplorer(folders, files) {
            var body = document.getElementById('explorerBody');
            var empty = document.getElementById('emptyState');

            if (folders.length === 0 && files.length === 0) {
                body.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            var html = '';

            folders.forEach(function(f) {
                var lockLabel = f.authType === 'pin' ? 'PIN' : 'PWD';
                html += '<tr ondblclick="openFolder(\'' + f.id + '\',\'' + escA(f.name) + '\',\'' + (f.authType || 'password') + '\')">'
                    + '<td><div class="cell-name">'
                    + '<div class="icon folder-icon">&#128193;</div>'
                    + '<span class="name-text">' + esc(f.name) + '</span>'
                    + '<span class="lock-badge">&#128274; ' + lockLabel + '</span>'
                    + '</div></td>'
                    + '<td class="cell-date">' + fmtDate(f.createdAt) + '</td>'
                    + '<td class="cell-size">‚Äî</td>'
                    + '<td class="cell-type">Folder</td>'
                    + '<td><div class="cell-actions">'
                    + '<button class="act-btn del" title="Hapus" onclick="event.stopPropagation();askDelete(\'folder\',\'' + f.id + '\',\'' + escA(f.name) + '\')">&#10005;</button>'
                    + '</div></td>'
                    + '</tr>';
            });

            files.forEach(function(f) {
                html += '<tr ondblclick="previewFile(\'' + f.id + '\',\'' + escA(f.originalName) + '\',\'' + escA(f.mimetype) + '\')">'
                    + '<td><div class="cell-name">'
                    + '<div class="icon file-icon">' + fileIcon(f.mimetype) + '</div>'
                    + '<span class="name-text">' + esc(f.originalName) + '</span>'
                    + '</div></td>'
                    + '<td class="cell-date">' + fmtDate(f.uploadedAt) + '</td>'
                    + '<td class="cell-size">' + fmtSize(f.size) + '</td>'
                    + '<td class="cell-type">' + fmtType(f.mimetype) + '</td>'
                    + '<td><div class="cell-actions">'
                    + '<button class="act-btn" title="Download" onclick="event.stopPropagation();downloadFile(\'' + f.id + '\')">&#11015;</button>'
                    + '<button class="act-btn del" title="Hapus" onclick="event.stopPropagation();askDelete(\'file\',\'' + f.id + '\',\'' + escA(f.originalName) + '\')">&#10005;</button>'
                    + '</div></td>'
                    + '</tr>';
            });

            body.innerHTML = html;
        }

        // ============ FOLDER NAVIGATION ============
        function openFolder(id, name, authType) {
            // Check if already unlocked
            if (folderTokens[id]) {
                enterFolder(id, name);
                return;
            }
            // Need to unlock
            unlockTarget = { id: id, name: name, authType: authType };
            document.getElementById('unlockTitle').textContent = 'Buka "' + name + '"';
            document.getElementById('unlockLabel').textContent = authType === 'pin' ? 'PIN' : 'Password';
            var unlockInput = document.getElementById('unlockInput');
            unlockInput.placeholder = authType === 'pin' ? 'Masukkan PIN' : 'Masukkan password';
            unlockInput.value = '';
            // Set input mode untuk PIN agar keyboard numeric muncul di mobile
            if (authType === 'pin') {
                unlockInput.setAttribute('inputmode', 'numeric');
            } else {
                unlockInput.removeAttribute('inputmode');
            }
            document.getElementById('unlockError').classList.remove('show');
            document.getElementById('unlockModal').classList.add('show');
            setTimeout(function() { unlockInput.focus(); }, 100);
        }

        async function doUnlock() {
            if (!unlockTarget) return;
            var value = document.getElementById('unlockInput').value.trim();
            var errEl = document.getElementById('unlockError');
            errEl.classList.remove('show');

            if (!value) {
                errEl.textContent = 'Masukkan ' + (unlockTarget.authType === 'pin' ? 'PIN' : 'password');
                errEl.classList.add('show');
                return;
            }

            try {
                var r = await fetch('api/folder/' + unlockTarget.id + '/unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: value })
                });
                var data = await r.json();
                if (!r.ok) {
                    errEl.textContent = data.error || 'Gagal';
                    errEl.classList.add('show');
                    return;
                }
                folderTokens[unlockTarget.id] = data.token;
                closeUnlockModal();
                enterFolder(unlockTarget.id, unlockTarget.name);
            } catch (e) {
                errEl.textContent = 'Koneksi gagal';
                errEl.classList.add('show');
            }
        }

        function closeUnlockModal() {
            document.getElementById('unlockModal').classList.remove('show');
            // Bersihkan input dan error saat modal ditutup
            document.getElementById('unlockInput').value = '';
            document.getElementById('unlockError').classList.remove('show');
            document.getElementById('unlockError').textContent = '';
            unlockTarget = null;
        }

        // ============ RESET PASSWORD ============
        function showResetPassword() {
            if (!unlockTarget) return;
            closeUnlockModal();
            document.getElementById('resetFolderName').textContent = unlockTarget.name;
            document.getElementById('resetLabel').textContent = unlockTarget.authType === 'pin' ? 'PIN Baru' : 'Password Baru';
            document.getElementById('resetInput').placeholder = unlockTarget.authType === 'pin' ? 'Masukkan PIN baru' : 'Masukkan password baru';
            document.getElementById('resetInput').value = '';
            document.getElementById('resetError').classList.remove('show');
            document.getElementById('resetSuccess').classList.remove('show');
            document.getElementById('resetModal').classList.add('show');
            setTimeout(function() { document.getElementById('resetInput').focus(); }, 100);
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('show');
            document.getElementById('resetInput').value = '';
            document.getElementById('resetError').classList.remove('show');
            document.getElementById('resetSuccess').classList.remove('show');
        }

        async function doResetPassword() {
            if (!unlockTarget) return;
            var newValue = document.getElementById('resetInput').value.trim();
            var errEl = document.getElementById('resetError');
            var sucEl = document.getElementById('resetSuccess');
            errEl.classList.remove('show');
            sucEl.classList.remove('show');

            if (!newValue) {
                errEl.textContent = 'Masukkan ' + (unlockTarget.authType === 'pin' ? 'PIN' : 'password') + ' baru';
                errEl.classList.add('show');
                return;
            }

            try {
                var r = await fetch('api/folder/' + unlockTarget.id + '/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newValue: newValue })
                });
                var data = await r.json();
                if (!r.ok) {
                    errEl.textContent = data.error || 'Reset gagal';
                    errEl.classList.add('show');
                    return;
                }
                
                // Save new token and auto-open folder
                folderTokens[unlockTarget.id] = data.token;
                sucEl.textContent = 'Reset berhasil! Membuka folder...';
                sucEl.classList.add('show');
                
                setTimeout(function() {
                    closeResetModal();
                    enterFolder(unlockTarget.id, unlockTarget.name);
                    unlockTarget = null;
                }, 1500);
            } catch (e) {
                errEl.textContent = 'Koneksi gagal';
                errEl.classList.add('show');
            }
        }

        function enterFolder(id, name) {
            // Cancel re-lock timer if re-entering quickly
            if (lockTimers[id]) {
                clearTimeout(lockTimers[id]);
                delete lockTimers[id];
            }
            folderPath.push({ id: id, name: name });
            currentFolder = id;
            loadFiles();
        }

        function navigateTo(index) {
            // Start re-lock timer for folder being left
            var leavingFolder = currentFolder;
            if (leavingFolder && folderTokens[leavingFolder]) {
                lockTimers[leavingFolder] = setTimeout(function() {
                    delete folderTokens[leavingFolder];
                    delete lockTimers[leavingFolder];
                }, 2000);
            }

            if (index < 0) {
                currentFolder = null;
                folderPath = [];
            } else {
                currentFolder = folderPath[index].id;
                folderPath = folderPath.slice(0, index + 1);
            }
            loadFiles();
        }

        function updateBreadcrumb() {
            var bc = document.getElementById('breadcrumb');
            var html = '';
            if (folderPath.length === 0) {
                html = '<a class="current">Root</a>';
            } else {
                html = '<a onclick="navigateTo(-1)">Root</a>';
                folderPath.forEach(function(f, i) {
                    html += '<span class="sep">&#9656;</span>';
                    if (i === folderPath.length - 1) {
                        html += '<a class="current">' + esc(f.name) + '</a>';
                    } else {
                        html += '<a onclick="navigateTo(' + i + ')">' + esc(f.name) + '</a>';
                    }
                });
            }
            bc.innerHTML = html;
        }

        // ============ CREATE FOLDER ============
        function showNewFolderModal() {
            document.getElementById('folderNameInput').value = '';
            document.getElementById('folderPassword').value = '';
            document.getElementById('folderPin').value = '';
            document.getElementById('folderError').classList.remove('show');
            document.getElementById('folderError').textContent = '';
            setAuthType('password');
            document.getElementById('folderModal').classList.add('show');
            setTimeout(function() { document.getElementById('folderNameInput').focus(); }, 100);
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.remove('show');
            // Bersihkan semua input saat modal ditutup
            document.getElementById('folderNameInput').value = '';
            document.getElementById('folderPassword').value = '';
            document.getElementById('folderPin').value = '';
            document.getElementById('folderError').classList.remove('show');
            document.getElementById('folderError').textContent = '';
        }

        function setAuthType(type) {
            newFolderAuthType = type;
            document.getElementById('optPwd').className = 'radio-opt' + (type === 'password' ? ' selected' : '');
            document.getElementById('optPin').className = 'radio-opt' + (type === 'pin' ? ' selected' : '');
            document.getElementById('pwdField').style.display = type === 'password' ? 'block' : 'none';
            document.getElementById('pinField').style.display = type === 'pin' ? 'block' : 'none';
        }

        async function createFolder() {
            var name = document.getElementById('folderNameInput').value.trim();
            var errEl = document.getElementById('folderError');
            errEl.classList.remove('show');

            if (!name) {
                errEl.textContent = 'Nama folder wajib diisi';
                errEl.classList.add('show');
                return;
            }

            var authValue = '';
            if (newFolderAuthType === 'password') {
                authValue = document.getElementById('folderPassword').value.trim();
                if (!authValue) {
                    errEl.textContent = 'Password wajib diisi';
                    errEl.classList.add('show');
                    return;
                }
            } else {
                authValue = document.getElementById('folderPin').value.trim();
                if (!authValue) {
                    errEl.textContent = 'PIN wajib diisi';
                    errEl.classList.add('show');
                    return;
                }
            }

            // Disable button to prevent double submit
            var submitBtn = event ? event.target : document.querySelector('#folderModal .m-ok');
            if (submitBtn) submitBtn.disabled = true;

            try {
                var headers = { 'Content-Type': 'application/json' };
                if (currentFolder && folderTokens[currentFolder]) {
                    headers['X-Folder-Token'] = folderTokens[currentFolder];
                }
                var r = await fetch('api/folder', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        name: name,
                        parentId: currentFolder,
                        authType: newFolderAuthType,
                        authValue: authValue
                    })
                });
                var data = await r.json();
                if (!r.ok) {
                    if (submitBtn) submitBtn.disabled = false;
                    errEl.textContent = data.error || 'Gagal buat folder';
                    errEl.classList.add('show');
                    return;
                }
                // Store the folder token
                if (data.folderToken) {
                    folderTokens[data.folder.id] = data.folderToken;
                }
                closeFolderModal();
                toast('Folder "' + name + '" dibuat', 'ok');
                loadFiles();
            } catch (e) {
                if (submitBtn) submitBtn.disabled = false;
                errEl.textContent = 'Gagal buat folder: ' + e.message;
                errEl.classList.add('show');
            }
        }

        // ============ UPLOAD ============
        var uploadZone = document.getElementById('uploadZone');
        var fileInput = document.getElementById('fileInput');

        function triggerUpload() { fileInput.click(); }
        uploadZone.addEventListener('click', function() { fileInput.click(); });

        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', function() {
            uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length) uploadFiles(fileInput.files);
            fileInput.value = '';
        });

        async function uploadFiles(list) {
            for (var i = 0; i < list.length; i++) {
                await uploadOne(list[i], i + 1, list.length);
            }
            loadFiles();
            loadStorage();
        }

        function uploadOne(file, num, total) {
            return new Promise(function(resolve) {
                var prog = document.getElementById('uploadProgress');
                var bar = document.getElementById('uploadBarFill');
                var info = document.getElementById('uploadInfo');
                prog.classList.add('show');
                bar.style.width = '0%';
                info.textContent = 'Mengupload (' + num + '/' + total + '): ' + file.name;

                var fd = new FormData();
                fd.append('file', file);
                if (currentFolder) fd.append('folderId', currentFolder);

                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'api/upload');
                if (currentFolder && folderTokens[currentFolder]) {
                    xhr.setRequestHeader('X-Folder-Token', folderTokens[currentFolder]);
                }

                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        var pct = (e.loaded / e.total * 100).toFixed(0);
                        bar.style.width = pct + '%';
                        info.textContent = 'Mengupload (' + num + '/' + total + '): ' + file.name + ' ‚Äî ' + pct + '%';
                    }
                };
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        toast(file.name + ' diupload', 'ok');
                    } else {
                        try { toast(JSON.parse(xhr.responseText).error || 'Upload gagal', 'err'); }
                        catch (x) { toast('Upload gagal', 'err'); }
                    }
                    prog.classList.remove('show');
                    resolve();
                };
                xhr.onerror = function() {
                    toast('Upload gagal', 'err');
                    prog.classList.remove('show');
                    resolve();
                };
                xhr.send(fd);
            });
        }

        // ============ DOWNLOAD ============
        function downloadFile(id) {
            var headers = {};
            if (currentFolder && folderTokens[currentFolder]) {
                headers['X-Folder-Token'] = folderTokens[currentFolder];
            }
            fetch('api/download/' + id, { headers: headers }).then(function(r) {
                if (!r.ok) { toast('Download gagal', 'err'); return; }
                var disp = r.headers.get('Content-Disposition');
                var fname = 'download';
                if (disp) { var m = disp.match(/filename="?(.+?)"?$/); if (m) fname = m[1]; }
                return r.blob().then(function(blob) {
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url; a.download = fname; a.click();
                    URL.revokeObjectURL(url);
                });
            }).catch(function() { toast('Download gagal', 'err'); });
        }

        // ============ FILE PREVIEW ============
        function previewFile(id, name, mimetype) {
            currentPreviewFile = { id: id, name: name, mimetype: mimetype };
            document.getElementById('previewTitle').textContent = name;
            
            var modal = document.getElementById('previewModal');
            var content = document.getElementById('previewContent');
            
            modal.classList.add('show');
            content.innerHTML = '<div class=\"preview-unsupported\"><div class=\"icon\">‚è≥</div><p>Loading...</p></div>';

            var headers = {};
            if (currentFolder && folderTokens[currentFolder]) {
                headers['X-Folder-Token'] = folderTokens[currentFolder];
            }

            fetch('api/download/' + id, { headers: headers })
                .then(function(r) {
                    if (!r.ok) throw new Error('Gagal memuat file');
                    return r.blob();
                })
                .then(function(blob) {
                    var url = URL.createObjectURL(blob);
                    var html = '';

                    // Image
                    if (mimetype.startsWith('image/')) {
                        html = '<img src=\"' + url + '\" alt=\"' + esc(name) + '\">';
                    }
                    // Video
                    else if (mimetype.startsWith('video/')) {
                        html = '<video controls preload=\"metadata\" src=\"' + url + '\"></video>';
                    }
                    // Audio
                    else if (mimetype.startsWith('audio/')) {
                        html = '<audio controls preload=\"metadata\" src=\"' + url + '\"></audio>';
                    }
                    // PDF
                    else if (mimetype === 'application/pdf') {
                        html = '<iframe src=\"' + url + '\"></iframe>';
                    }
                    // Text files
                    else if (mimetype.startsWith('text/') || 
                             mimetype === 'application/json' ||
                             mimetype === 'application/javascript' ||
                             mimetype === 'application/xml') {
                        blob.text().then(function(text) {
                            content.innerHTML = '<pre>' + esc(text) + '</pre>';
                        });
                        return;
                    }
                    // Unsupported
                    else {
                        html = '<div class=\"preview-unsupported\">'
                            + '<div class=\"icon\">üìÑ</div>'
                            + '<p>Format file ini tidak bisa di-preview</p>'
                            + '<p style=\"font-size:11px;color:#555;margin-top:8px;\">Klik Download untuk mengunduh file</p>'
                            + '</div>';
                    }

                    content.innerHTML = html;
                })
                .catch(function(err) {
                    content.innerHTML = '<div class=\"preview-unsupported\">'
                        + '<div class=\"icon\">‚ùå</div>'
                        + '<p>Gagal memuat file</p>'
                        + '<p style=\"font-size:11px;color:#555;margin-top:8px;\">' + esc(err.message) + '</p>'
                        + '</div>';
                });
        }

        function closePreview() {
            document.getElementById('previewModal').classList.remove('show');
            var content = document.getElementById('previewContent');
            
            // Clean up media elements
            var media = content.querySelector('video, audio');
            if (media) {
                media.pause();
                media.src = '';
            }
            
            // Clean up object URLs
            var img = content.querySelector('img');
            if (img && img.src.startsWith('blob:')) {
                URL.revokeObjectURL(img.src);
            }
            var iframe = content.querySelector('iframe');
            if (iframe && iframe.src.startsWith('blob:')) {
                URL.revokeObjectURL(iframe.src);
            }
            
            content.innerHTML = '';
            currentPreviewFile = null;
        }

        function downloadCurrentPreview() {
            if (currentPreviewFile) {
                downloadFile(currentPreviewFile.id);
            }
        }

        // ============ DELETE ============
        function askDelete(type, id, name) {
            deleteTarget = { type: type, id: id };
            document.getElementById('deleteTitle').textContent = type === 'folder' ? 'Hapus Folder?' : 'Hapus File?';
            document.getElementById('deleteMsg').textContent = type === 'folder'
                ? 'Folder "' + name + '" dan seluruh isinya akan dihapus permanen.'
                : 'File "' + name + '" akan dihapus permanen.';
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteTarget = null;
        }

        async function confirmDelete() {
            if (!deleteTarget) return;
            var t = deleteTarget.type, id = deleteTarget.id;
            closeDeleteModal();

            try {
                var endpoint = t === 'folder' ? 'folder/' + id : 'delete/' + id;
                var headers = {};
                if (t === 'folder' && folderTokens[id]) {
                    headers['X-Folder-Token'] = folderTokens[id];
                } else if (currentFolder && folderTokens[currentFolder]) {
                    headers['X-Folder-Token'] = folderTokens[currentFolder];
                }
                var r = await fetch('api/' + endpoint, { method: 'DELETE', headers: headers });
                if (r.ok) {
                    toast('Dihapus', 'ok');
                    loadFiles();
                    loadStorage();
                } else {
                    var data = await r.json();
                    toast(data.error || 'Gagal hapus', 'err');
                }
            } catch (e) {
                toast('Gagal hapus', 'err');
            }
        }

        // ============ KEYBOARD ============
        document.addEventListener('keydown', function(e) {
            if (e.key !== 'Enter') return;
            if (document.getElementById('folderModal').classList.contains('show')) createFolder();
            else if (document.getElementById('unlockModal').classList.contains('show')) doUnlock();
        });

        // ============ UTILS ============
        function fmtSize(b) {
            if (!b || b === 0) return '0 B';
            var u = ['B','KB','MB','GB'];
            var i = Math.floor(Math.log(b) / Math.log(1024));
            return (b / Math.pow(1024, i)).toFixed(i > 1 ? 1 : 0) + ' ' + u[i];
        }

        function fmtDate(iso) {
            if (!iso) return '‚Äî';
            var d = new Date(iso);
            var dd = d.getDate(), mm = d.getMonth() + 1, yy = d.getFullYear();
            var hh = ('0' + d.getHours()).slice(-2), mn = ('0' + d.getMinutes()).slice(-2);
            return dd + '/' + mm + '/' + yy + ' ' + hh + ':' + mn;
        }

        function fmtType(mime) {
            if (!mime) return 'File';
            if (mime.startsWith('image/')) return 'Image';
            if (mime.startsWith('video/')) return 'Video';
            if (mime.startsWith('audio/')) return 'Audio';
            if (mime.indexOf('pdf') !== -1) return 'PDF';
            if (mime.indexOf('zip') !== -1 || mime.indexOf('rar') !== -1 || mime.indexOf('7z') !== -1) return 'Archive';
            if (mime.indexOf('word') !== -1 || mime.indexOf('document') !== -1) return 'Document';
            if (mime.indexOf('sheet') !== -1 || mime.indexOf('excel') !== -1) return 'Spreadsheet';
            if (mime.indexOf('text') !== -1) return 'Text';
            return 'File';
        }

        function fileIcon(mime) {
            if (!mime) return '&#128196;';
            if (mime.startsWith('image/')) return '&#128247;';
            if (mime.startsWith('video/')) return '&#127909;';
            if (mime.startsWith('audio/')) return '&#127925;';
            if (mime.indexOf('pdf') !== -1) return '&#128213;';
            if (mime.indexOf('zip') !== -1 || mime.indexOf('rar') !== -1 || mime.indexOf('7z') !== -1) return '&#128230;';
            if (mime.indexOf('word') !== -1 || mime.indexOf('document') !== -1) return '&#128196;';
            if (mime.indexOf('sheet') !== -1 || mime.indexOf('excel') !== -1) return '&#128202;';
            return '&#128196;';
        }

        function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function escA(s) { return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

        function toast(msg, type) {
            var box = document.getElementById('toastBox');
            var el = document.createElement('div');
            el.className = 'toast ' + (type || 'ok');
            el.textContent = msg;
            box.appendChild(el);
            setTimeout(function() { el.style.opacity = '0'; el.style.transition = 'opacity .3s'; setTimeout(function() { el.remove(); }, 300); }, 3000);
        }

        // ============ KEYBOARD SHORTCUTS ============
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close preview modal if open
                if (document.getElementById('previewModal').classList.contains('show')) {
                    closePreview();
                }
            }
        });

        // ============ INIT ============
        loadFiles();
        loadStorage();
    </script>
</body>
</html>