<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HarywangCloud</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #0a0a0a;
            color: #e5e5e5;
            min-height: 100vh;
        }

        /* ============ AUTH SCREENS ============ */

        .auth-overlay {
            position: fixed; inset: 0;
            background: #0a0a0a;
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
            animation: fadeIn .3s;
        }

        .auth-box {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-box h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #10b981, #34d399);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-box p {
            color: #737373;
            font-size: 14px;
            margin-bottom: 28px;
        }

        .auth-box .field {
            margin-bottom: 16px;
            text-align: left;
        }

        .auth-box label {
            display: block;
            font-size: 13px;
            color: #a3a3a3;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .auth-box input {
            width: 100%;
            padding: 12px 14px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: border-color .2s;
        }

        .auth-box input:focus {
            border-color: #10b981;
        }

        .auth-box input::placeholder {
            color: #525252;
        }

        .auth-box .hint {
            font-size: 11px;
            color: #525252;
            margin-top: 4px;
        }

        .auth-box .btn-primary {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: opacity .2s, transform .1s;
        }

        .auth-box .btn-primary:hover { opacity: .9; }
        .auth-box .btn-primary:active { transform: scale(.98); }

        .auth-box .divider {
            display: flex; align-items: center; gap: 12px;
            margin: 20px 0;
            color: #404040;
            font-size: 12px;
        }

        .auth-box .divider::before,
        .auth-box .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #262626;
        }

        .auth-box .toggle-link {
            color: #10b981;
            cursor: pointer;
            font-size: 13px;
            text-decoration: underline;
            background: none;
            border: none;
        }

        .auth-error {
            background: #450a0a;
            border: 1px solid #7f1d1d;
            color: #fca5a5;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }

        .auth-error.show { display: block; }

        /* ============ MAIN APP ============ */

        .app { display: none; }
        .app.active { display: block; }

        .header {
            padding: 20px 24px;
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: rgba(10,10,10,.92);
            backdrop-filter: blur(12px);
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .header-left .logo {
            width: 36px; height: 36px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: #fff;
        }

        .header-left h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .storage-bar-mini {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #171717;
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid #262626;
        }

        .storage-bar-mini .bar {
            width: 100px;
            height: 6px;
            background: #262626;
            border-radius: 3px;
            overflow: hidden;
        }

        .storage-bar-mini .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 3px;
            transition: width .4s ease;
        }

        .storage-bar-mini span {
            font-size: 12px;
            color: #a3a3a3;
            white-space: nowrap;
        }

        .btn-logout {
            padding: 8px 14px;
            background: #1c1c1c;
            border: 1px solid #333;
            border-radius: 8px;
            color: #a3a3a3;
            font-size: 13px;
            cursor: pointer;
            transition: all .2s;
        }

        .btn-logout:hover {
            background: #2a1215;
            border-color: #7f1d1d;
            color: #fca5a5;
        }

        /* ============ TOOLBAR ============ */

        .toolbar {
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 0;
            flex-wrap: wrap;
        }

        .breadcrumb a {
            color: #10b981;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity .2s;
            white-space: nowrap;
        }

        .breadcrumb a:hover { opacity: .7; }

        .breadcrumb a.current {
            color: #e5e5e5;
            cursor: default;
        }

        .breadcrumb .sep {
            color: #404040;
            font-size: 12px;
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 9px 16px;
            border-radius: 9px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all .2s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn-green {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }

        .btn-green:hover { opacity: .85; }

        .btn-outline {
            background: transparent;
            border: 1px solid #333;
            color: #d4d4d4;
        }

        .btn-outline:hover {
            background: #1c1c1c;
            border-color: #444;
        }

        /* ============ FILE GRID ============ */

        .content {
            padding: 0 24px 24px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 24px;
            color: #525252;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state p {
            font-size: 15px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .card {
            background: #141414;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all .2s;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            border-color: #333;
            background: #1a1a1a;
            transform: translateY(-2px);
        }

        .card .card-icon {
            width: 44px; height: 44px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            margin-bottom: 12px;
        }

        .card.folder .card-icon {
            background: rgba(234, 179, 8, .15);
        }

        .card.file .card-icon {
            background: rgba(16, 185, 129, .15);
        }

        .card .card-name {
            font-size: 13px;
            font-weight: 500;
            color: #e5e5e5;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 4px;
            padding-right: 28px;
        }

        .card .card-info {
            font-size: 11px;
            color: #525252;
        }

        .card .card-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity .2s;
        }

        .card:hover .card-actions { opacity: 1; }

        .card .card-actions button {
            width: 28px; height: 28px;
            border-radius: 6px;
            border: none;
            background: rgba(255,255,255,.06);
            color: #a3a3a3;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all .15s;
        }

        .card .card-actions button:hover {
            background: rgba(255,255,255,.12);
            color: #fff;
        }

        .card .card-actions button.del:hover {
            background: rgba(239, 68, 68, .2);
            color: #ef4444;
        }

        /* ============ MODALS ============ */

        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all .2s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 14px;
            padding: 28px;
            width: 90%;
            max-width: 400px;
            transform: scale(.95);
            transition: transform .2s;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal h3 {
            font-size: 18px;
            margin-bottom: 16px;
        }

        .modal input {
            width: 100%;
            padding: 11px 14px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            outline: none;
            margin-bottom: 16px;
        }

        .modal input:focus { border-color: #10b981; }

        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btns button {
            padding: 9px 20px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity .2s;
        }

        .modal-btns .cancel {
            background: #262626;
            color: #a3a3a3;
        }

        .modal-btns .confirm {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }

        /* ============ UPLOAD AREA ============ */

        .upload-zone {
            border: 2px dashed #262626;
            border-radius: 14px;
            padding: 32px;
            text-align: center;
            margin-bottom: 20px;
            transition: all .3s;
            cursor: pointer;
        }

        .upload-zone.dragover {
            border-color: #10b981;
            background: rgba(16,185,129,.05);
        }

        .upload-zone .uz-icon { font-size: 36px; margin-bottom: 10px; }

        .upload-zone p { color: #737373; font-size: 14px; }

        .upload-zone .sub { font-size: 12px; color: #404040; margin-top: 4px; }

        .upload-progress {
            display: none;
            margin-bottom: 20px;
        }

        .upload-progress.show { display: block; }

        .upload-progress .bar-wrap {
            width: 100%;
            height: 8px;
            background: #1c1c1c;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .upload-progress .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 4px;
            transition: width .3s;
            width: 0%;
        }

        .upload-progress .info {
            font-size: 12px;
            color: #737373;
        }

        /* ============ TOAST ============ */

        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: #1c1c1c;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 12px 18px;
            font-size: 13px;
            color: #e5e5e5;
            animation: slideUp .3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.success { border-color: #065f46; }
        .toast.error { border-color: #7f1d1d; color: #fca5a5; }

        /* ============ ANIMATIONS ============ */

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ============ RESPONSIVE ============ */

        @media (max-width: 600px) {
            .header { padding: 14px 16px; }
            .toolbar { padding: 12px 16px; }
            .content { padding: 0 16px 16px; }
            .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
            .storage-bar-mini { display: none; }
            .auth-box { padding: 28px 20px; margin: 16px; }
        }
    </style>
</head>
<body>
    <!-- AUTH SCREEN -->
    <div id="authScreen" class="auth-overlay" style="display:none;">
        <!-- Setup Form -->
        <div id="setupBox" class="auth-box" style="display:none;">
            <h1>HarywangCloud</h1>
            <p>Buat password dan PIN untuk mengamankan data kamu</p>
            <div id="setupError" class="auth-error"></div>
            <div class="field">
                <label>Password</label>
                <input type="text" id="setupPassword" placeholder="Contoh: HARY123" autocomplete="off" spellcheck="false">
                <div class="hint">Huruf besar (A-Z) dan angka (0-9), minimal 4 karakter</div>
            </div>
            <div class="field">
                <label>PIN</label>
                <input type="password" id="setupPin" placeholder="6 digit angka" maxlength="6" inputmode="numeric">
                <div class="hint">PIN 6 digit untuk login cepat</div>
            </div>
            <button class="btn-primary" onclick="doSetup()">Buat Akun</button>
        </div>

        <!-- Login Form -->
        <div id="loginBox" class="auth-box" style="display:none;">
            <h1>HarywangCloud</h1>
            <p>Masukkan password atau PIN untuk masuk</p>
            <div id="loginError" class="auth-error"></div>
            <div id="loginPasswordField" class="field">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Masukkan password" autocomplete="off">
            </div>
            <div id="loginPinField" class="field" style="display:none;">
                <label>PIN</label>
                <input type="password" id="loginPin" placeholder="6 digit PIN" maxlength="6" inputmode="numeric">
            </div>
            <button class="btn-primary" onclick="doLogin()">Masuk</button>
            <div class="divider">atau</div>
            <button class="toggle-link" id="toggleAuth" onclick="toggleLoginMode()">Masuk dengan PIN</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="app">
        <div class="header">
            <div class="header-left">
                <div class="logo">&#9729;</div>
                <h1>HarywangCloud</h1>
            </div>
            <div class="header-right">
                <div class="storage-bar-mini">
                    <div class="bar"><div class="bar-fill" id="storageBarFill"></div></div>
                    <span id="storageText">--</span>
                </div>
                <button class="btn-logout" onclick="doLogout()">Logout</button>
            </div>
        </div>

        <div class="toolbar">
            <div class="breadcrumb" id="breadcrumb">
                <a class="current">Root</a>
            </div>
            <div class="toolbar-actions">
                <button class="btn btn-outline" onclick="showNewFolderModal()">+ Folder</button>
                <button class="btn btn-green" onclick="triggerUpload()">Upload</button>
            </div>
        </div>

        <div class="content">
            <div class="upload-zone" id="uploadZone">
                <div class="uz-icon">&#128228;</div>
                <p>Klik atau drag file ke sini untuk upload</p>
                <div class="sub">Maksimal 500MB per file</div>
            </div>

            <div class="upload-progress" id="uploadProgress">
                <div class="bar-wrap"><div class="bar-fill" id="uploadBarFill"></div></div>
                <div class="info" id="uploadInfo">Mengupload...</div>
            </div>

            <div id="fileGrid" class="grid"></div>
            <div id="emptyState" class="empty-state" style="display:none;">
                <div class="icon">&#128193;</div>
                <p>Folder ini masih kosong</p>
            </div>
        </div>
    </div>

    <!-- NEW FOLDER MODAL -->
    <div class="modal-overlay" id="folderModal">
        <div class="modal">
            <h3>Buat Folder Baru</h3>
            <input type="text" id="folderNameInput" placeholder="Nama folder" maxlength="100">
            <div class="modal-btns">
                <button class="cancel" onclick="closeFolderModal()">Batal</button>
                <button class="confirm" onclick="createFolder()">Buat</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRM MODAL -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h3 id="deleteTitle">Hapus?</h3>
            <p style="color:#a3a3a3;font-size:14px;margin-bottom:20px;" id="deleteMsg">Item ini akan dihapus permanen.</p>
            <div class="modal-btns">
                <button class="cancel" onclick="closeDeleteModal()">Batal</button>
                <button class="confirm" style="background:#dc2626;" onclick="confirmDelete()">Hapus</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- HIDDEN FILE INPUT -->
    <input type="file" id="fileInput" style="display:none;" multiple>

    <script>
        // ============ STATE ============
        let authToken = localStorage.getItem('cloud_token') || '';
        let currentFolder = null;
        let folderPath = [];
        let deleteTarget = null;
        let loginMode = 'password';

        // ============ API HELPER ============
        function api(endpoint, opts = {}) {
            const headers = opts.headers || {};
            if (authToken) headers['X-Auth-Token'] = authToken;
            if (opts.json) {
                headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(opts.json);
                delete opts.json;
            }
            return fetch('api/' + endpoint, { ...opts, headers });
        }

        // ============ AUTH ============
        async function checkAuth() {
            try {
                const r = await api('auth/status');
                const data = await r.json();
                if (!data.isSetup) { showAuthScreen('setup'); return; }
                if (!data.isLoggedIn) { showAuthScreen('login'); return; }
                showApp();
            } catch (e) {
                showAuthScreen('login');
            }
        }

        function showAuthScreen(mode) {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
            document.getElementById('setupBox').style.display = mode === 'setup' ? 'block' : 'none';
            document.getElementById('loginBox').style.display = mode === 'login' ? 'block' : 'none';
        }

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('app').classList.add('active');
            loadFiles();
            loadStorage();
        }

        async function doSetup() {
            const password = document.getElementById('setupPassword').value.trim();
            const pin = document.getElementById('setupPin').value.trim();
            const errEl = document.getElementById('setupError');
            errEl.classList.remove('show');

            if (!password || !pin) {
                errEl.textContent = 'Password dan PIN wajib diisi';
                errEl.classList.add('show');
                return;
            }

            try {
                const r = await api('auth/setup', { method: 'POST', json: { password, pin } });
                const data = await r.json();
                if (!r.ok) {
                    errEl.textContent = data.error || 'Gagal setup';
                    errEl.classList.add('show');
                    return;
                }
                authToken = data.token;
                localStorage.setItem('cloud_token', authToken);
                toast('Akun berhasil dibuat!', 'success');
                showApp();
            } catch (e) {
                errEl.textContent = 'Koneksi gagal';
                errEl.classList.add('show');
            }
        }

        async function doLogin() {
            const errEl = document.getElementById('loginError');
            errEl.classList.remove('show');

            const body = {};
            if (loginMode === 'password') {
                body.password = document.getElementById('loginPassword').value.trim();
                if (!body.password) { errEl.textContent = 'Masukkan password'; errEl.classList.add('show'); return; }
            } else {
                body.pin = document.getElementById('loginPin').value.trim();
                if (!body.pin) { errEl.textContent = 'Masukkan PIN'; errEl.classList.add('show'); return; }
            }

            try {
                const r = await api('auth/login', { method: 'POST', json: body });
                const data = await r.json();
                if (!r.ok) {
                    errEl.textContent = data.error || 'Login gagal';
                    errEl.classList.add('show');
                    return;
                }
                authToken = data.token;
                localStorage.setItem('cloud_token', authToken);
                toast('Login berhasil!', 'success');
                showApp();
            } catch (e) {
                errEl.textContent = 'Koneksi gagal';
                errEl.classList.add('show');
            }
        }

        function doLogout() {
            authToken = '';
            localStorage.removeItem('cloud_token');
            currentFolder = null;
            folderPath = [];
            showAuthScreen('login');
        }

        function toggleLoginMode() {
            const toggle = document.getElementById('toggleAuth');
            if (loginMode === 'password') {
                loginMode = 'pin';
                document.getElementById('loginPasswordField').style.display = 'none';
                document.getElementById('loginPinField').style.display = 'block';
                toggle.textContent = 'Masuk dengan Password';
            } else {
                loginMode = 'password';
                document.getElementById('loginPasswordField').style.display = 'block';
                document.getElementById('loginPinField').style.display = 'none';
                toggle.textContent = 'Masuk dengan PIN';
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            if (document.getElementById('setupBox').style.display === 'block') doSetup();
            else if (document.getElementById('loginBox').style.display === 'block') doLogin();
            else if (document.getElementById('folderModal').classList.contains('show')) createFolder();
        });

        // ============ FILES & FOLDERS ============
        async function loadFiles() {
            try {
                const url = currentFolder ? 'files?folder=' + currentFolder : 'files';
                const r = await api(url);
                if (r.status === 401) { doLogout(); return; }
                const data = await r.json();
                renderGrid(data.folders || [], data.files || []);
                updateBreadcrumb();
            } catch (e) {
                toast('Gagal memuat file', 'error');
            }
        }

        async function loadStorage() {
            try {
                const r = await api('storage');
                if (!r.ok) return;
                const data = await r.json();
                const pct = (data.used / data.total * 100).toFixed(1);
                document.getElementById('storageBarFill').style.width = pct + '%';
                document.getElementById('storageText').textContent = formatSize(data.used) + ' / ' + formatSize(data.total);
            } catch (e) {}
        }

        function renderGrid(folders, files) {
            const grid = document.getElementById('fileGrid');
            const empty = document.getElementById('emptyState');

            if (folders.length === 0 && files.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            let html = '';

            folders.forEach(f => {
                html += '<div class="card folder" ondblclick="openFolder(\'' + f.id + '\',\'' + escAttr(f.name) + '\')">'
                    + '<div class="card-actions">'
                    + '<button class="del" title="Hapus folder" onclick="event.stopPropagation();askDelete(\'folder\',\'' + f.id + '\',\'' + escAttr(f.name) + '\')">&#10005;</button>'
                    + '</div>'
                    + '<div class="card-icon">&#128193;</div>'
                    + '<div class="card-name">' + esc(f.name) + '</div>'
                    + '<div class="card-info">Folder</div>'
                    + '</div>';
            });

            files.forEach(f => {
                html += '<div class="card file" ondblclick="downloadFile(\'' + f.id + '\')">'
                    + '<div class="card-actions">'
                    + '<button title="Download" onclick="event.stopPropagation();downloadFile(\'' + f.id + '\')">&#11015;</button>'
                    + '<button class="del" title="Hapus" onclick="event.stopPropagation();askDelete(\'file\',\'' + f.id + '\',\'' + escAttr(f.originalName) + '\')">&#10005;</button>'
                    + '</div>'
                    + '<div class="card-icon">' + fileIcon(f.mimetype) + '</div>'
                    + '<div class="card-name">' + esc(f.originalName) + '</div>'
                    + '<div class="card-info">' + formatSize(f.size) + '</div>'
                    + '</div>';
            });

            grid.innerHTML = html;
        }

        function openFolder(id, name) {
            folderPath.push({ id: id, name: name });
            currentFolder = id;
            loadFiles();
        }

        function navigateTo(index) {
            if (index < 0) {
                currentFolder = null;
                folderPath = [];
            } else {
                currentFolder = folderPath[index].id;
                folderPath = folderPath.slice(0, index + 1);
            }
            loadFiles();
        }

        function updateBreadcrumb() {
            const bc = document.getElementById('breadcrumb');
            let html = '';

            if (folderPath.length === 0) {
                html = '<a class="current">Root</a>';
            } else {
                html = '<a onclick="navigateTo(-1)">Root</a>';
                folderPath.forEach(function(f, i) {
                    html += '<span class="sep">&#9656;</span>';
                    if (i === folderPath.length - 1) {
                        html += '<a class="current">' + esc(f.name) + '</a>';
                    } else {
                        html += '<a onclick="navigateTo(' + i + ')">' + esc(f.name) + '</a>';
                    }
                });
            }

            bc.innerHTML = html;
        }

        // ============ UPLOAD ============
        var uploadZone = document.getElementById('uploadZone');
        var fileInput = document.getElementById('fileInput');

        function triggerUpload() { fileInput.click(); }

        uploadZone.addEventListener('click', function() { fileInput.click(); });

        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', function() {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', function() {
            if (fileInput.files.length) uploadFiles(fileInput.files);
            fileInput.value = '';
        });

        async function uploadFiles(fileList) {
            for (var i = 0; i < fileList.length; i++) {
                await uploadSingle(fileList[i], i + 1, fileList.length);
            }
            loadFiles();
            loadStorage();
        }

        function uploadSingle(file, num, total) {
            return new Promise(function(resolve) {
                var progEl = document.getElementById('uploadProgress');
                var barFill = document.getElementById('uploadBarFill');
                var info = document.getElementById('uploadInfo');

                progEl.classList.add('show');
                info.textContent = 'Mengupload (' + num + '/' + total + '): ' + file.name;
                barFill.style.width = '0%';

                var formData = new FormData();
                formData.append('file', file);
                if (currentFolder) formData.append('folderId', currentFolder);

                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'api/upload');
                xhr.setRequestHeader('X-Auth-Token', authToken);

                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        var pct = (e.loaded / e.total * 100).toFixed(0);
                        barFill.style.width = pct + '%';
                        info.textContent = 'Mengupload (' + num + '/' + total + '): ' + file.name + ' â€” ' + pct + '%';
                    }
                };

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        toast(file.name + ' berhasil diupload', 'success');
                    } else {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            toast(data.error || 'Upload gagal', 'error');
                        } catch (ex) {
                            toast('Upload gagal', 'error');
                        }
                        if (xhr.status === 401) doLogout();
                    }
                    progEl.classList.remove('show');
                    resolve();
                };

                xhr.onerror = function() {
                    toast('Upload gagal (koneksi error)', 'error');
                    progEl.classList.remove('show');
                    resolve();
                };

                xhr.send(formData);
            });
        }

        // ============ DOWNLOAD ============
        function downloadFile(id) {
            api('download/' + id).then(function(r) {
                if (r.status === 401) { doLogout(); return; }
                if (!r.ok) { toast('Download gagal', 'error'); return; }
                var disposition = r.headers.get('Content-Disposition');
                var filename = 'download';
                if (disposition) {
                    var match = disposition.match(/filename="?(.+?)"?$/);
                    if (match) filename = match[1];
                }
                return r.blob().then(function(blob) {
                    var url = URL.createObjectURL(blob);
                    var link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();
                    URL.revokeObjectURL(url);
                });
            }).catch(function() { toast('Download gagal', 'error'); });
        }

        // ============ DELETE ============
        function askDelete(type, id, name) {
            deleteTarget = { type: type, id: id };
            document.getElementById('deleteTitle').textContent = type === 'folder' ? 'Hapus Folder?' : 'Hapus File?';
            document.getElementById('deleteMsg').textContent =
                type === 'folder'
                    ? 'Folder "' + name + '" dan semua isinya akan dihapus permanen.'
                    : 'File "' + name + '" akan dihapus permanen.';
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteTarget = null;
        }

        async function confirmDelete() {
            if (!deleteTarget) return;
            var type = deleteTarget.type;
            var id = deleteTarget.id;
            closeDeleteModal();

            try {
                var endpoint = type === 'folder' ? 'folder/' + id : 'delete/' + id;
                var r = await api(endpoint, { method: 'DELETE' });
                if (r.status === 401) { doLogout(); return; }
                if (r.ok) {
                    toast('Berhasil dihapus', 'success');
                    loadFiles();
                    loadStorage();
                } else {
                    var data = await r.json();
                    toast(data.error || 'Gagal menghapus', 'error');
                }
            } catch (ex) {
                toast('Gagal menghapus', 'error');
            }
        }

        // ============ FOLDER MODAL ============
        function showNewFolderModal() {
            document.getElementById('folderNameInput').value = '';
            document.getElementById('folderModal').classList.add('show');
            setTimeout(function() { document.getElementById('folderNameInput').focus(); }, 100);
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.remove('show');
        }

        async function createFolder() {
            var name = document.getElementById('folderNameInput').value.trim();
            if (!name) return;
            closeFolderModal();

            try {
                var r = await api('folder', {
                    method: 'POST',
                    json: { name: name, parentId: currentFolder }
                });
                if (r.status === 401) { doLogout(); return; }
                if (r.ok) {
                    toast('Folder "' + name + '" dibuat', 'success');
                    loadFiles();
                } else {
                    var data = await r.json();
                    toast(data.error || 'Gagal buat folder', 'error');
                }
            } catch (ex) {
                toast('Gagal buat folder', 'error');
            }
        }

        // ============ UTILS ============
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            var units = ['B', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(i > 1 ? 1 : 0) + ' ' + units[i];
        }

        function fileIcon(mime) {
            if (!mime) return '&#128196;';
            if (mime.startsWith('image/')) return '&#128247;';
            if (mime.startsWith('video/')) return '&#127909;';
            if (mime.startsWith('audio/')) return '&#127925;';
            if (mime.indexOf('pdf') !== -1) return '&#128213;';
            if (mime.indexOf('zip') !== -1 || mime.indexOf('rar') !== -1 || mime.indexOf('7z') !== -1) return '&#128230;';
            if (mime.indexOf('word') !== -1 || mime.indexOf('document') !== -1) return '&#128196;';
            if (mime.indexOf('sheet') !== -1 || mime.indexOf('excel') !== -1) return '&#128202;';
            if (mime.indexOf('text') !== -1) return '&#128221;';
            return '&#128196;';
        }

        function esc(str) {
            var d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        function escAttr(str) {
            return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function toast(msg, type) {
            type = type || 'success';
            var container = document.getElementById('toastContainer');
            var el = document.createElement('div');
            el.className = 'toast ' + type;
            el.innerHTML = (type === 'success' ? '&#10003; ' : '&#10007; ') + esc(msg);
            container.appendChild(el);
            setTimeout(function() {
                el.style.opacity = '0';
                el.style.transition = 'opacity .3s';
                setTimeout(function() { el.remove(); }, 300);
            }, 3000);
        }

        // ============ INIT ============
        checkAuth();
    </script>
</body>
</html>